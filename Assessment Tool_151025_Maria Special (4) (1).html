<html lang="en"><head>
<meta charset="utf-8"/>
<title>Plant Skills</title>
<style>
    /* Reset and base styles */
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f8f8;
      color: #333;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0;
      padding: 0;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      /* A bold blue background for the header */
      background-color: #1a73e8;
      color: #ffffff;
      border-bottom: 1px solid #005bb5;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .toolbar .inputs label {
      margin-right: 12px;
      font-size: 0.85rem;
    }
    .toolbar input {
      padding: 4px;
      font-size: 0.85rem;
    }
    .toolbar .actions button {
      margin-left: 8px;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      border: 1px solid #888;
      border-radius: 4px;
      background-color: #fafafa;
    }
    .toolbar .actions button:hover {
      background-color: #f0f0f0;
    }
    #legend {
      padding: 8px 16px;
      font-size: 0.8rem;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
    }

    /* Site navigation styles */
    .site-nav {
      padding: 8px 16px;
      font-size: 0.9rem;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
      /* Make the navigation bar sticky so it remains visible when scrolling. */
      position: sticky;
      /* Position below the top toolbar. Adjust this value if the toolbar height changes. */
      top: 40px;
      z-index: 90;
    }
    .site-nav button {
      margin-right: 8px;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      border: 1px solid #888;
      border-radius: 4px;
      background-color: #fafafa;
    }
    .site-nav button:hover {
      background-color: #f0f0f0;
    }
    /* Table styles */
    .view {
      overflow-y: auto;
      overflow-x: hidden;
      height: calc(100vh - 140px);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 0.8rem;
    }
    thead th {
      position: sticky;
      top: 0;
      background-color: #f0f0f0;
      padding: 6px 4px;
      border-bottom: 1px solid #ccc;
      z-index: 50;
    }
    tbody td {
      padding: 4px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
      word-wrap: break-word;
    }
    tbody tr:nth-child(even) td {
      background-color: #fafafa;
    }
    /* Column widths to avoid horizontal scroll */
    /* Column widths sum to 100% to avoid horizontal scroll */
    .col-dept { width: 9%; }
    /* Removed the separate Cluster column. The cluster name will be displayed within the role cell instead. */
    /* .col-cluster { ... } is no longer used */
    /* Updated column widths for the new layout: the removed cluster column width is merged into the role column. */
    /* The role column is reduced to about 20% of the table width on the
       main worksheet. The freed‚Äëup space is allocated to the comment
       columns (comments and mitigation details) to improve readability. */
    .col-role { width: 20%; }
    .col-crit { width: 7%; text-align: center; }
    .col-cap { width: 7%; text-align: center; }
    .col-ret { width: 7%; text-align: center; }
    .col-overall { width: 7%; text-align: center; }
    /* Comments column width is increased and font slightly reduced for readability */
    /* Increase the comments column width to 29% and reduce the role column
       accordingly. This provides more space for long capability and
       retention notes. */
    /* Allocate column widths such that the Comments and Mitigation Details
       columns have the same width.  By setting both to 22% and keeping
       the other columns unchanged, the total width remains 100%: 20% (Role)
       + 7% (Criticality) + 7% (Capability) + 7% (Retention Risk) + 7%
       (Overall Risk) + 22% (Comments) + 8% (Preferred Method) + 22%
       (Mitigation Details) = 100%.  The reduced comments width still
       provides ample room for notes while matching the mitigation details
       column for a balanced look. */
    .col-comments { width: 22%; font-size: 0.75rem; line-height: 1.3; }
    .col-pref { width: 8%; text-align: center; }
    .col-gap { width: 22%; }
    /* RAG colours */
    /* Row separator line for better readability */
    tbody tr:not(.dept-section) td {
      border-bottom: 1px solid #eee;
    }
    /* RAG colour classes with !important to override row striping */
    .crit-1 { background-color: #d7e7d3 !important; color: #004400 !important; }
    .crit-2 { background-color: #fff5d6 !important; color: #8a6d00 !important; }
    .crit-3 { background-color: #f8d7da !important; color: #842029 !important; }

    /* Summary card tables styling */
    .summary-card table {
      border-collapse: collapse;
      width: 100%;
    }
    .summary-card th,
    .summary-card td {
      padding: 4px 6px;
      border-right: 1px solid #cccccc;
      border-bottom: 1px solid #cccccc;
    }
    .summary-card th:last-child,
    .summary-card td:last-child {
      border-right: none;
    }
    /* Equal widths for risk columns in the As‚ÄëIs summary. The first column is
       slightly reduced (24%) to free up space for the other risk columns.
       The remaining four columns each take up an equal share of the rest of
       the table width. */
    /* Adjust the As‚ÄëIs summary table so the role column is about 20% of the
       total width, freeing up space for the four risk columns. Each of
       the risk columns now shares the remaining 80% evenly (20% each).
       This change gives more room to the capability and comments in the
       summary view. */
    .summary-card.as-is table th:nth-child(1),
    .summary-card.as-is table td:nth-child(1) {
      width: 20%;
    }
    .summary-card.as-is table th:nth-child(2),
    .summary-card.as-is table td:nth-child(2),
    .summary-card.as-is table th:nth-child(3),
    .summary-card.as-is table td:nth-child(3),
    .summary-card.as-is table th:nth-child(4),
    .summary-card.as-is table td:nth-child(4),
    .summary-card.as-is table th:nth-child(5),
    .summary-card.as-is table td:nth-child(5) {
      width: 20%;
    }

    /* Styling for the capability heatmap table */
    .cap-heatmap table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.75rem;
    }
    .cap-heatmap th,
    .cap-heatmap td {
      padding: 4px 6px;
      border-right: 1px solid #cccccc;
      border-bottom: 1px solid #cccccc;
      vertical-align: top;
    }
    .cap-heatmap th:last-child,
    .cap-heatmap td:last-child {
      border-right: none;
    }
    .cap-heatmap tr:nth-child(even) td {
      background-color: #f9f9f9;
    }

    /* Apply light alternating row shading to summary tables as well. This
       uses the same colour as the heatmap so that any grey backgrounds
       scroll naturally with the content rather than appearing fixed. */
    .summary-card table tr:nth-child(even) td {
      background-color: #f9f9f9;
    }
    .cap-1 { background-color: #f8d7da !important; color: #842029 !important; }
    /* Medium capability (amber) uses the same yellow as other RAG buckets to ensure
       consistency across all tables. */
    .cap-2 { background-color: #fff5d6 !important; color: #8a6d00 !important; }
    .cap-3 { background-color: #d7e7d3 !important; color: #004400 !important; }
    .ret-L { background-color: #d7e7d3 !important; color: #004400 !important; }
    .ret-M { background-color: #fff5d6 !important; color: #8a6d00 !important; }
    .ret-H { background-color: #f8d7da !important; color: #842029 !important; }
    .ret-null { background-color: #e7e7e7 !important; color: #666 !important; }
    .overall-Low { background-color: #d7e7d3 !important; color: #004400 !important; }
    .overall-Medium { background-color: #fff5d6 !important; color: #8a6d00 !important; }
    .overall-High { background-color: #f8d7da !important; color: #842029 !important; }
    .overall-Critical { background-color: #e5b7b9 !important; color: #660000 !important; animation: pulse 2s infinite !important; }
    @media (prefers-reduced-motion: reduce) {
      .overall-Critical { animation: none; }
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(132,32,41, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(132,32,41, 0); }
      100% { box-shadow: 0 0 0 0 rgba(132,32,41, 0); }
    }

    /* Department section rows span all columns. Use a light background and bold text for section headers */
    tr.dept-section td {
      background-color: #eef2f7;
      font-weight: bold;
      padding: 6px;
    }
    /* Hide department section header rows entirely since this version of the tool
       no longer distinguishes pulp-specific vs shared departments. This prevents
       the grey lines (pulp-specific departments, shared with paper mill) from
       being displayed. */
    tr.dept-section {
      display: none !important;
    }
    /* Popover */
    .popover {
      position: absolute;
      background-color: #ffffff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 8px;
      z-index: 200;
      font-size: 0.8rem;
    }
    .popover label {
      display: block;
      margin-bottom: 4px;
    }
    .popover select {
      width: 100%;
      margin-bottom: 6px;
    }
    .popover button {
      margin-right: 4px;
      padding: 4px 8px;
      font-size: 0.8rem;
    }
    /* Summary view */
    #summaryView {
      padding: 8px;
    }
    .summary-card {
      background-color: #fff;
      border: 1px solid #ddd;
      margin-bottom: 12px;
      padding: 8px;
    }
    .summary-card h2 {
      margin: 0 0 6px 0;
      font-size: 1rem;
    }
    .summary-card table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 6px;
      font-size: 0.75rem;
      table-layout: fixed;
    }
    .summary-card th, .summary-card td {
      /* Use a consistent grey border on all sides to create clear vertical and
         horizontal separators. This slightly darker shade ensures column
         dividers remain visible without being too heavy. */
      border: 1px solid #cccccc;
      padding: 4px;
      text-align: left;
      word-wrap: break-word;
      white-space: normal;
    }
    .hidden { display: none; }

    /* Neutral style for missing criticality values */
    .crit-null { background-color: #e7e7e7; color: #666; }

    /* Preserve newlines in comment and gap cells */
    .col-comments {
      white-space: pre-wrap;
    }
    .col-gap {
      white-space: pre-wrap;
    }
    /* Print styles */
    @media print {
      body { font-size: 10pt; }
      .toolbar, #legend, .popover { display: none !important; }
      #summaryView, #dataView { overflow: visible; height: auto; }
      thead th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
      .crit-1, .crit-2, .crit-3,
      .cap-1, .cap-2, .cap-3,
      .ret-L, .ret-M, .ret-H, .ret-null,
      .overall-Low, .overall-Medium, .overall-High, .overall-Critical {
        -webkit-print-color-adjust: exact;
      }
    }

    /* Start view styling */
    #startView {
      padding: 0;
    }
    .start-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 16px;
    }
    .start-intro, .start-guidance {
      background: #fff;
      padding: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 24px;
    }
    .start-intro p {
      margin: 0 0 1em 0;
    }
    .start-guidance h3 {
      margin-top: 0;
    }
    .start-guidance ul {
      list-style-type: disc;
      padding-left: 20px;
    }
    .start-buttons {
      /* Display the mill buttons in a responsive grid.  We use flexbox with
         wrapping so the nine mills wrap onto two rows when the container
         width allows.  Each button takes up roughly 20% of the available
         width minus the gap, yielding five buttons on the first row and
         four on the second. */
      margin: 24px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: center;
    }
    .start-buttons button {
      flex: 1 0 calc(20% - 16px);
      padding: 12px;
      font-size: 1rem;
      cursor: pointer;
      border: 1px solid #888;
      border-radius: 4px;
      background-color: #fafafa;
      text-align: center;
    }
    .start-buttons button:hover {
      background-color: #f0f0f0;
    }

    /* Provide extra space below the reset button to separate it from the
       guidance box. */
    .start-reset {
      margin-bottom: 24px;
    }

    /* Highlight the active site in the navigation bar.  The active-site
       button uses the same blue as the header with white text for
       contrast. */
    .site-nav button.active-site {
      background-color: #1a73e8;
      color: #fff;
    }
    .site-nav button.active-site:hover {
      background-color: #1a5bc2;
    }

    /* Hide any grey section rows that were specific to the old pulp mill layout. */
    .dept-section {
      display: none;
    }
  </style>
</head>
<body>
<!-- Start view shown when no site selected -->
<div id="startView" style="display: none;">
<div class="toolbar">
<h1 style="margin:0; font-size:1.4rem; padding: 8px 16px; background-color: #1a73e8; color: #fff; display:flex; align-items:center;">
<span aria-label="factory" role="img" style="margin-right:6px;">üè≠</span>Welcome
      </h1>
</div>
<div class="start-container">
<div class="start-intro">
<p>This tool has been created to help us assess the skills, capabilities, retention risks, and mitigation plans for our plant.</p>
<p>Please use it as a structured way to review data, identify gaps, and plan actions for improvement.</p>
</div>
<!-- Added a simple name input so users can enter their name before starting.
     The name is collected for courtesy but not displayed on subsequent pages. -->
<div class="start-input-wrapper" style="text-align:center; margin-top:12px; margin-bottom:12px; display:flex; justify-content:center; align-items:center; flex-wrap:wrap; gap:8px;">
  <label for="startUserName" style="margin-right:4px; font-weight:bold;">Name:</label>
  <input id="startUserName" type="text" placeholder="Enter your name" style="padding:4px; border:1px solid #ccc; border-radius:4px; width:200px;">
  <!-- Removed Plant Name input. Only user name is needed now. -->
</div>
<!-- Only three options are available on the combined tool.  Each button calls loadSite() with the exact site name. -->
<!-- Mill selection buttons and action buttons on the welcome page -->
<div class="start-buttons">
  <!-- Buttons to launch the assessment for each individual mill -->
  <button onclick="startSite('Billingfors Pulp')">Billingfors‚ÄØPulp</button>
  <button onclick="startSite('Billingfors Paper and Shared')">Billingfors‚ÄØPaper‚ÄØand‚ÄØShared</button>
  <button onclick="startSite('J√∂nk√∂ping')">J√∂nk√∂ping</button>
</div>
<div class="start-actions" style="display:flex; flex-wrap:wrap; gap:16px; justify-content:center; margin-top:12px;">
  <!-- Upload button opens the consolidation view where multiple CSV responses can be uploaded -->
  <button onclick="showConsolidation()">Upload responses</button>
  <!-- Download all data across mills as a single CSV -->
  <!-- Bind the save/download buttons via JavaScript in initializeApplication() -->
  <button id="downloadCsv">Download CSV</button>
  <button id="saveVersion">Save</button>
</div>
<!-- Reset button to restore the default starting data. Only shown on the welcome page. -->
<div class="start-reset" style="text-align:center; margin-top:12px;">
<button onclick="resetData()" style="background-color:#d9534f; color:#fff; padding:6px 12px; border:none; border-radius:4px; cursor:pointer;">Reset Data</button>
</div>
<div class="start-guidance">
<h3>Good Practice for Workshops</h3>
<p>As we work through the data, please keep these points in mind:</p>
<ul>
<li>Challenge each other. Ask questions, test assumptions, and make sure ratings are accurate.</li>
<li>Step 1: Review whether criticality, capabilities, and retention risk have been rated effectively.</li>
<li>Step 2: Discuss our current methods for addressing any gaps identified.</li>
<li>Stay open and constructive. The more we challenge, the stronger and more reliable our data will be.</li>
<li>Focus on improvement. Our goal is to ensure we have the right approach for addressing gaps and building capability.</li>
</ul>
</div>
</div>
</div>
<!-- Site content container; hidden until a site is selected -->
<!-- Consolidation view is defined outside of startView so it can be shown independently of the welcome page -->
<div id="consolidationView" style="display:none;">
  <div class="toolbar">
    <h1><span aria-label="factory" role="img" style="margin-right:6px;">üìÑ</span>Consolidate Responses</h1>
  </div>
  <div class="site-nav">
    <strong>Navigation:</strong>
    <button onclick="showStart()">Back to Start</button>
  </div>
  <div class="consolidate-container" style="padding:16px;">
    <!-- Hidden file input for selecting multiple CSVs -->
    <input id="uploadInput" type="file" accept=".csv" multiple style="display:none;">
    <div style="margin-bottom:12px; display:flex; flex-wrap:wrap; gap:8px;">
      <button id="uploadBtn">Upload responses</button>
      <button id="processBtn">Process</button>
      <button id="downloadConsolidatedBtn">Download consolidated CSV</button>
      <button id="updateToolBtn">Update tool with consolidated data</button>
      <button id="clearConsolidatedBtn">Clear Data</button>
    </div>
    <!-- Area where the consolidated table will be rendered -->
    <div id="consolidatedOutput"></div>
  </div>
</div>
<div id="siteContent" style="">
<div class="toolbar">
<div class="title">
<h1><span aria-label="factory" role="img" style="margin-right:6px;">üè≠</span>Plant Skills Assessment</h1>
</div>
<div class="inputs">
<!-- User Name input removed -->
<label>Mill: <input id="inputMill" placeholder="Enter mill" type="text"/></label>
</div>
<div class="actions">
<button id="toggleSummary">Show Summary</button>
      <!-- Site-level download and save buttons removed; these actions are now only available on the welcome page. -->
      <button id="printBtn">Print</button>
</div>
</div>
<!-- Navigation for switching between mill sites and returning to start. -->
<div class="site-nav">
<strong>Navigation:</strong>
<button onclick="showStart()">Back to Start</button>
</div>
<div class="view" id="dataView">
<table id="dataTable">
<thead>
<tr>
<!-- Removed Department and Cluster columns. Role column now contains cluster on top and role name below -->
<th class="col-role" title="Role">Role</th>
<!-- Removed the separate Cluster column; cluster name will be shown above the role name -->
<th class="col-crit" title="1 ‚Äì Essential, but short-term gaps can be managed. Impact is felt over months or years if not addressed.&#10;&#10;&#10;2 ‚Äì Important and increasingly disruptive if missing for weeks or months. Sustained absence reduces effectiveness and performance.&#10;&#10;&#10;3 ‚Äì Vital for ongoing operations or delivery. Any short-term lapse (days or weeks) causes immediate and significant disruption.">Criticality</th>
<th class="col-cap" title="1 ‚Äì Significant Gap: Current capability is well below what the role requires. Consistent support or development needed to perform effectively.&#10;&#10;&#10;2 ‚Äì Adequate / Developing: Meets most role requirements but with room for improvement. Performs competently in familiar situations; some growth still needed for full mastery.&#10;&#10;&#10;3 ‚Äì Strong Performance: Fully meets or exceeds expectations for the role. Demonstrates consistent, high-quality performance and applies the capability effectively in complex or changing contexts.">Capability</th>
<th class="col-ret" title="Retention Risk (H‚ÄìM‚ÄìL scale):&#10;&#10;&#10;High: Likely to leave within 12 months. Clear indicators such as approaching retirement, active job search, dissatisfaction with role, leadership, or culture, or pay notably below market. Requires immediate action.&#10;&#10;&#10;Medium: Possible departure within 1‚Äì2 years. Some signs of disengagement, partial dissatisfaction, or moderate pay gap. Retention depends on improved development, recognition, or future opportunities.&#10;&#10;&#10;Low: Unlikely to leave in the foreseeable future. Individual is satisfied, well-compensated, and engaged with their work and environment. Risk limited to unexpected external offers or life events.">Retention Risk</th>
<th class="col-overall" title="Overall Risk">Overall Risk</th>
<th class="col-comments" title="Comments">Comments</th>
<th class="col-pref" title="Mitigation">Mitigation</th>
<th class="col-gap" title="Mitigation Details">Mitigation Details</th>
</tr>
</thead>
<tbody><tr class="dept-section"><td colspan="8">Pulp-Mill Specifc Departments</td></tr><tr data-row-id="0"><td class="col-role"><strong>Operations Manager</strong></td><td class="col-crit crit-3" data-field="criticality" data-row-id="0" tabindex="0">3.0</td><td class="col-cap cap-2" data-field="capability" data-row-id="0" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);" tabindex="0">2.2</td><td class="col-ret ret-M" data-field="retentionRisk" data-row-id="0" tabindex="0">M</td><td class="col-overall overall-High">High</td><td class="col-comments" data-field="comments" data-row-id="0" tabindex="0"><strong>Capability:</strong><br/>- No internal successor<br/>- Critical for plant leadership/safety<br/>- Limited financial expertise in pipeline<br/>- Gaps in accountability/team guidance<br/>- Reactive; lacks strategic vision<br/>- Weak safety culture<br/>- Production prioritised over safety<br/>- Knowledge gap: Water &amp; Power<br/><br/><strong>Retention:</strong><br/>- Position vacant; backfill needed<br/>- No succession plan</td><td class="col-pref" data-field="preferredMethod" data-row-id="0" tabindex="0">Buy</td><td class="col-gap" data-field="gapMethodComment" data-row-id="0" tabindex="0">Hiring due to force exit of previous Ops Manager. Currently managed by existing team and considered low risk.

External search in progress, in addition, considering internal move for Ryan from May (due to personal circumstances). Need to assess fit as part of the process.

Changes needed:
Leaders with to bring a stronger vision and execution of improvement plan.
Operational improvement require changes in systems (process / technology / ways of working). Short-term external support could be useful, but longer term CI needed for implementation.</td></tr><tr data-row-id="1"><td class="col-role"><strong>Shift Supervision</strong></td><td class="col-crit crit-3" data-field="criticality" data-row-id="1" tabindex="0">3.0</td><td class="col-cap cap-2" data-field="capability" data-row-id="1" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);" tabindex="0">2.0</td><td class="col-ret ret-L" data-field="retentionRisk" data-row-id="1" tabindex="0">L</td><td class="col-overall overall-Medium">Medium</td><td class="col-comments" data-field="comments" data-row-id="1" tabindex="0"><strong>Capability:</strong><br/>- - Crisis management: Follow procedures, decide, communicate<br/>- - Strong troubleshooters; advocate for hourly staff<br/>- - Lack proactive approach<br/>- - Struggle balancing relationships with leadership<br/>- - Hesitant to challenge upward<br/>- - Change-resistant<br/>- - Limited upward support affects coaching ability<br/>- - Inconsistent safety practices<br/>- - Easy to recruit; attractive 12-hour schedule<br/><br/><strong>Retention:</strong><br/>- - One approaching retirement</td><td class="col-pref" data-field="preferredMethod" data-row-id="1" tabindex="0">Build</td><td class="col-gap" data-field="gapMethodComment" data-row-id="1" tabindex="0">1 Shift supervisor role open and in recruitment process. 

Additional training and development needed to strengthen people management skill (could be cross-plant effort).</td></tr><tr data-row-id="2"><td class="col-role"><strong>Production Manager Wood Yard</strong></td><td class="col-crit crit-1" data-field="criticality" data-row-id="2" tabindex="0">1.0</td><td class="col-cap cap-2" data-field="capability" data-row-id="2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);" tabindex="0">1.8</td><td class="col-ret ret-L" data-field="retentionRisk" data-row-id="2" tabindex="0">L</td><td class="col-overall overall-Low">Low</td><td class="col-comments" data-field="comments" data-row-id="2" tabindex="0"><strong>Capability:</strong><br/>- - Easiest area; mechanical focus<br/>- - Safety critical (heavy equipment)<br/>- - Manager: Calm, logical, proactive<br/>- - Extensive woodyard experience<br/>- - Strong relationships<br/>- - Clear expectations; weak documentation/discipline<br/>- - Good for developing new leaders<br/>- - Could hire engineer if needed<br/>- Low Crisis management<br/><br/><strong>Retention:</strong><br/>- - Succession planning needed</td><td class="col-pref" data-field="preferredMethod" data-row-id="2" tabindex="0">-</td><td class="col-gap" data-field="gapMethodComment" data-row-id="2" tabindex="0">Organisation could be changed to have this lead by a process engineer (more junior). Low risk area.</td></tr><tr data-row-id="3"><td class="col-role"><strong>Production Manager Fiber</strong></td><td class="col-crit crit-3" data-field="criticality" data-row-id="3" tabindex="0">3.0</td><td class="col-cap cap-2" data-field="capability" data-row-id="3" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);" tabindex="0">1.8</td><td class="col-ret ret-M" data-field="retentionRisk" data-row-id="3" tabindex="0">M</td><td class="col-overall overall-High">High</td><td class="col-comments" data-field="comments" data-row-id="3" tabindex="0"><strong>Capability:</strong><br/>- - Pulping/washing requires long development<br/>- - Major digester safety risk<br/>- - Manager drives continuous improvement<br/>- - Strong LOTO/MOC practices<br/>- - Chemical Engineer<br/>- - Excellent technical; developing leadership<br/>- - Process control/centre-lining expertise<br/>- - Highly marketable skills<br/>- - Long ramp-up time<br/>- - Weak replacement pipeline<br/>- - Difficult to fill<br/>- Low Experience<br/><br/><strong>Retention:</strong><br/>- - Focus on retention (scarce skills)</td><td class="col-pref" data-field="preferredMethod" data-row-id="3" tabindex="0">Bot</td><td class="col-gap" data-field="gapMethodComment" data-row-id="3" tabindex="0">Currently this is a very manual process. Large opportunity to improve systems and automation. Could start seeing results within 18 months.

For capablity building a plan is needed. Could consider external can help, e.g., Tom (someone that really understand liquor cycle). Cross training with Thilmany.

Need to assess retirement intentions of incumbent and need strong succession building plan.</td></tr><tr data-row-id="4"><td class="col-role"><strong>Production manager Recovery or Alkali</strong></td><td class="col-crit crit-3" data-field="criticality" data-row-id="4" tabindex="0">3.0</td><td class="col-cap cap-2" data-field="capability" data-row-id="4" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);" tabindex="0">2.4</td><td class="col-ret ret-M" data-field="retentionRisk" data-row-id="4" tabindex="0">M</td><td class="col-overall overall-High">High</td><td class="col-comments" data-field="comments" data-row-id="4" tabindex="0"><strong>Capability:</strong><br/>- - Most complex/highest risk process<br/>- - 5+ years to proficiency<br/>- - Few market candidates<br/>- - Strong team-builder<br/>- - Clear communicator<br/>- - Critical for Alkali investment<br/>- - Respected; values safety<br/>- - Minimal replacement pipeline<br/>- - Must train internally<br/>- - Limited regional market<br/><br/><strong>Retention:</strong><br/>- - Essential to retain<br/>- - 5-year retirement window<br/>- - No succession options</td><td class="col-pref" data-field="preferredMethod" data-row-id="4" tabindex="0">Build</td><td class="col-gap" data-field="gapMethodComment" data-row-id="4" tabindex="0">Significant retention risk due to high demand / low supply of specialist talent. Need retention conversation and potential retention plan. Individual looking fir more opportunities, driving complex projects. Should also be assessed for Ope Manager role.

Below only one potential successor and no other bench strength.</td></tr><tr data-row-id="5"><td class="col-role"><strong>Production manager Utilities</strong></td><td class="col-crit crit-3" data-field="criticality" data-row-id="5" tabindex="0">3.0</td><td class="col-cap cap-2" data-field="capability" data-row-id="5" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);" tabindex="0">2.4</td><td class="col-ret ret-M" data-field="retentionRisk" data-row-id="5" tabindex="0">M</td><td class="col-overall overall-High">High</td><td class="col-comments" data-field="comments" data-row-id="5" tabindex="0"><strong>Capability:</strong><br/>- - Most complex/highest risk<br/>- - 5+ years to proficiency<br/>- - Few market candidates<br/>- - Paper Science Engineer<br/>- - Deep systems knowledge<br/>- - Logical approach<br/>- - Avoids confrontation<br/>- - High personal standards<br/>- - Minimal pipeline<br/>- - Flight risk (education/local opportunities)<br/><br/><strong>Retention:</strong><br/>- - Essential to retain<br/>- - No succession options<br/>- - Difficult to fill<br/>- - 5-7 year retirement window</td><td class="col-pref" data-field="preferredMethod" data-row-id="5" tabindex="0">-</td><td class="col-gap" data-field="gapMethodComment" data-row-id="5" tabindex="0">Same person as above.</td></tr><tr data-row-id="6"><td class="col-role"><strong>Environmental Services</strong></td><td class="col-crit crit-1" data-field="criticality" data-row-id="6" tabindex="0">1.0</td><td class="col-cap cap-2" data-field="capability" data-row-id="6" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);" tabindex="0">2.4</td><td class="col-ret ret-M" data-field="retentionRisk" data-row-id="6" tabindex="0">M</td><td class="col-overall overall-Low">Low</td><td class="col-comments" data-field="comments" data-row-id="6" tabindex="0"><strong>Capability:</strong><br/>- - Basic if sewer losses controlled<br/>- - Easy to recruit<br/>- - Equipment similar to municipal plants<br/><br/><strong>Retention:</strong><br/>- - Monitor needs</td><td class="col-pref" data-field="preferredMethod" data-row-id="6" tabindex="0">Bot</td><td class="col-gap" data-field="gapMethodComment" data-row-id="6" tabindex="0">Opportunity to revise the structure, this is more operator level.</td></tr><tr data-row-id="7"><td class="col-role"><strong>Process Engineering</strong></td><td class="col-crit crit-3" data-field="criticality" data-row-id="7" tabindex="0">3.0</td><td class="col-cap cap-2" data-field="capability" data-row-id="7" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);" tabindex="0">1.8</td><td class="col-ret ret-H" data-field="retentionRisk" data-row-id="7" tabindex="0">H</td><td class="col-overall overall-Critical">Critical</td><td class="col-comments" data-field="comments" data-row-id="7" tabindex="0"><strong>Capability:</strong><br/>- - Automation improves performance/costs<br/>- - Young engineer, 2-year controls degree<br/>- - Fast learner; quickly relied upon<br/>- - Strong under pressure<br/>- - Difficult to recruit<br/>- - Automation expertise in demand<br/>- - Understaffed; single person<br/>- - Highly marketable<br/>- - Growth-oriented<br/>- - Relocatable<br/>- Low Experience<br/><br/><strong>Retention:</strong><br/>- - Focus on retention (scarce skills)</td><td class="col-pref" data-field="preferredMethod" data-row-id="7" tabindex="0">Build</td><td class="col-gap" data-field="gapMethodComment" data-row-id="7" tabindex="0">Retention - likely to go back to school, full or part time. No succession plan. Not aware of plans to leave but big risk.

Need to build this strength.

Could look at structure and use these for some of the other roles.

Need to build their CI skills.</td></tr><tr data-row-id="8"><td class="col-role"><strong>Pulp-Specific Maintenance</strong></td><td class="col-crit crit-3" data-field="criticality" data-row-id="8" tabindex="0">3.0</td><td class="col-cap cap-2" data-field="capability" data-row-id="8" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);" tabindex="0">2.4</td><td class="col-ret ret-L" data-field="retentionRisk" data-row-id="8" tabindex="0">L</td><td class="col-overall overall-Medium">Medium</td><td class="col-comments" data-field="comments" data-row-id="8" tabindex="0"><strong>Capability:</strong><br/>- - Inadequate maintenance (vessels, boilers, turbines, kilns)<br/>- - Causes: Limited funds/knowledge<br/>- - Team knowledgeable but underutilised<br/>- - Operations Manager creates barriers<br/>- - Transferable/marketable skills<br/><br/><strong>Retention:</strong><br/>- - Monitor needs</td><td class="col-pref" data-field="preferredMethod" data-row-id="8" tabindex="0">-</td><td class="col-gap" data-field="gapMethodComment" data-row-id="8" tabindex="0">Some people retiring, but good bench strength underneath.</td></tr><tr class="dept-section"><td colspan="8">Shared with Papermill</td></tr><tr data-row-id="9"><td class="col-role"><strong>Maintenance &amp; Reliability</strong></td><td class="col-crit crit-3" data-field="criticality" data-row-id="9" tabindex="0">3.0</td><td class="col-cap cap-2" data-field="capability" data-row-id="9" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);" tabindex="0">2.0</td><td class="col-ret ret-M" data-field="retentionRisk" data-row-id="9" tabindex="0">M</td><td class="col-overall overall-High">High</td><td class="col-comments" data-field="comments" data-row-id="9" tabindex="0"><strong>Capability:</strong><br/>- - Team knowledgeable but underutilised<br/>- - Operations Manager creates barriers<br/>- - Transferable/marketable skills<br/>- Low Crisis management<br/><br/><strong>Retention:</strong><br/>- - Monitor needs</td><td class="col-pref" data-field="preferredMethod" data-row-id="9" tabindex="0">Build</td><td class="col-gap" data-field="gapMethodComment" data-row-id="9" tabindex="0">Keep training.

Need to develop strong training plans (could be cross-plant initiative) 

Big capacity issue due to limited resources: Example, when we have failure we don't have enough capacity. Not enough reliability work, we need to have this capacity for at least a few years. Could be cross-plant.</td></tr><tr data-row-id="10"><td class="col-role"><strong>Project Engineering</strong></td><td class="col-crit crit-2" data-field="criticality" data-row-id="10" tabindex="0">2.0</td><td class="col-cap cap-3" data-field="capability" data-row-id="10" style="background-color: rgb(215, 231, 211); color: rgb(0, 68, 0);" tabindex="0">2.6</td><td class="col-ret ret-M" data-field="retentionRisk" data-row-id="10" tabindex="0">M</td><td class="col-overall overall-Medium">Medium</td><td class="col-comments" data-field="comments" data-row-id="10" tabindex="0"><strong>Capability:</strong><br/>- - Strongest mill team<br/>- - Strained leadership relationship<br/>- - Transferable/marketable skills<br/>- - Young, educated team<br/><br/><strong>Retention:</strong><br/>- - Monitor needs</td><td class="col-pref" data-field="preferredMethod" data-row-id="10" tabindex="0">Build</td><td class="col-gap" data-field="gapMethodComment" data-row-id="10" tabindex="0"></td></tr><tr data-row-id="11"><td class="col-role"><strong>Quality Assurance</strong></td><td class="col-crit crit-1" data-field="criticality" data-row-id="11" tabindex="0">1.0</td><td class="col-cap cap-1" data-field="capability" data-row-id="11" style="background-color: rgb(248, 215, 218); color: rgb(132, 32, 41);" tabindex="0">0.6</td><td class="col-ret ret-L" data-field="retentionRisk" data-row-id="11" tabindex="0">L</td><td class="col-overall overall-Low">Low</td><td class="col-comments" data-field="comments" data-row-id="11" tabindex="0"><strong>Capability:</strong><br/>- - Responsibilities distributed across teams<br/>- Low Technical knowledge<br/>- Low Leadership &amp; Communication<br/>- Low Safety mindset<br/><br/><strong>Retention:</strong><br/>- - Monitor needs</td><td class="col-pref" data-field="preferredMethod" data-row-id="11" tabindex="0">-</td><td class="col-gap" data-field="gapMethodComment" data-row-id="11" tabindex="0"></td></tr><tr data-row-id="12"><td class="col-role"><strong>Health Safety &amp; Environment</strong></td><td class="col-crit crit-3" data-field="criticality" data-row-id="12" tabindex="0">3.0</td><td class="col-cap cap-2" data-field="capability" data-row-id="12" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);" tabindex="0">2.0</td><td class="col-ret ret-H" data-field="retentionRisk" data-row-id="12" tabindex="0">H</td><td class="col-overall overall-Critical">Critical</td><td class="col-comments" data-field="comments" data-row-id="12" tabindex="0"><strong>Capability:</strong><br/>- - Significant LOTO system progress<br/>- - Fostering mill-wide safety engagement<br/>- - Multiple hourly rotations<br/>- Low Technical knowledge<br/><br/><strong>Retention:</strong><br/>- - Safety Manager departing</td><td class="col-pref" data-field="preferredMethod" data-row-id="12" tabindex="0">Buy</td><td class="col-gap" data-field="gapMethodComment" data-row-id="12" tabindex="0">Open position</td></tr></tbody>
</table>
</div>
<div class="view hidden" id="summaryView"><div class="summary-card as-is"><h2>As-Is Summary</h2><table><thead><tr><th>Role Area</th><th>Criticality</th><th>Capability (avg)</th><th>Retention Risk</th><th>Overall Risk</th></tr></thead><tbody><tr><td>Operations Manager</td><td class="crit-3">3.0</td><td class="cap-2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);">2.2</td><td class="ret-H">H</td><td class="overall-Critical">Critical</td></tr><tr><td>Shift Supervision</td><td class="crit-3">3.0</td><td class="cap-2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);">1.6</td><td class="ret-M">M</td><td class="overall-High">High</td></tr><tr><td>Production Manager Fiber</td><td class="crit-3">3.0</td><td class="cap-2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);">2.2</td><td class="ret-M">M</td><td class="overall-High">High</td></tr><tr><td>Production manager Recovery or Alkali</td><td class="crit-3">3.0</td><td class="cap-2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);">2.4</td><td class="ret-M">M</td><td class="overall-High">High</td></tr><tr><td>Production manager Utilities</td><td class="crit-3">3.0</td><td class="cap-2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);">2.0</td><td class="ret-M">M</td><td class="overall-High">High</td></tr><tr><td>Pulp-Specific Maintenance</td><td class="crit-3">3.0</td><td class="cap-2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);">2.0</td><td class="ret-M">M</td><td class="overall-High">High</td></tr><tr><td>Maintenance &amp; Reliability</td><td class="crit-3">3.0</td><td class="cap-2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);">2.0</td><td class="ret-M">M</td><td class="overall-High">High</td></tr><tr><td>Health Safety &amp; Environment</td><td class="crit-3">3.0</td><td class="cap-2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);">2.2</td><td class="ret-M">M</td><td class="overall-High">High</td></tr><tr><td>Environmental Services</td><td class="crit-2">2.0</td><td class="cap-2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);">2.0</td><td class="ret-M">M</td><td class="overall-Medium">Medium</td></tr><tr><td>Process Engineering</td><td class="crit-2">2.0</td><td class="cap-2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);">1.6</td><td class="ret-M">M</td><td class="overall-Medium">Medium</td></tr><tr><td>Project Engineering</td><td class="crit-2">2.0</td><td class="cap-2" style="background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);">1.8</td><td class="ret-L">L</td><td class="overall-Medium">Medium</td></tr><tr><td>Quality Assurance</td><td class="crit-2">2.0</td><td class="cap-1" style="background-color: rgb(248, 215, 218); color: rgb(132, 32, 41);">1.2</td><td class="ret-L">L</td><td class="overall-Medium">Medium</td></tr><tr><td>Production Manager Wood Yard</td><td class="crit-0">0.0</td><td class="cap-1" style="background-color: rgb(248, 215, 218); color: rgb(132, 32, 41);">0.6</td><td class="ret-M">M</td><td>-</td></tr></tbody></table></div><div class="summary-card cap-heatmap"><h2>Capability As-Is</h2><table><thead><tr><th>Role Area</th><th>Technical knowledge</th><th>Experience</th><th>Crisis management</th><th>Leadership &amp; Communication</th><th>Safety mindset</th><th>Overall capability rating</th></tr></thead><tbody><tr><td>Operations Manager</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-3">3.0</td><td class="cap-2">2.2</td></tr><tr><td>Shift Supervision</td><td class="cap-1">1.0</td><td class="cap-2">2.0</td><td class="cap-1">1.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">1.6</td></tr><tr><td>Production Manager Wood Yard</td><td class="cap-1">1.0</td><td class="cap-1">0.0</td><td class="cap-1">0.0</td><td class="cap-1">1.0</td><td class="cap-1">1.0</td><td class="cap-1">0.6</td></tr><tr><td>Production Manager Fiber</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-3">3.0</td><td class="cap-2">2.2</td></tr><tr><td>Production manager Recovery or Alkali</td><td class="cap-2">2.0</td><td class="cap-3">3.0</td><td class="cap-2">2.0</td><td class="cap-3">3.0</td><td class="cap-2">2.0</td><td class="cap-2">2.4</td></tr><tr><td>Production manager Utilities</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td></tr><tr><td>Environmental Services</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td></tr><tr><td>Process Engineering</td><td class="cap-2">2.0</td><td class="cap-1">1.0</td><td class="cap-1">1.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">1.6</td></tr><tr><td>Pulp-Specific Maintenance</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td></tr><tr><td>Maintenance &amp; Reliability</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td></tr><tr><td>Project Engineering</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-1">1.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">1.8</td></tr><tr><td>Quality Assurance</td><td class="cap-1">1.0</td><td class="cap-1">1.0</td><td class="cap-1">1.0</td><td class="cap-1">1.0</td><td class="cap-2">2.0</td><td class="cap-1">1.2</td></tr><tr><td>Health Safety &amp; Environment</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-2">2.0</td><td class="cap-3">3.0</td><td class="cap-2">2.2</td></tr></tbody></table></div><div class="summary-card"><h2>Capability vs Criticality (Quadrants)</h2><div style="display: flex; flex-wrap: wrap;"><div style="flex: 1 0 45%; border: 1px solid rgb(221, 221, 221); margin: 4px; padding: 4px; background-color: rgb(215, 231, 211); color: rgb(0, 68, 0);"><strong>High Capability &amp; High Criticality</strong><ul><li>Operations Manager</li><li>Production Manager Fiber</li><li>Production manager Recovery or Alkali</li><li>Production manager Utilities</li><li>Environmental Services</li><li>Pulp-Specific Maintenance</li><li>Maintenance &amp; Reliability</li><li>Health Safety &amp; Environment</li></ul></div><div style="flex: 1 0 45%; border: 1px solid rgb(221, 221, 221); margin: 4px; padding: 4px; background-color: rgb(248, 215, 218); color: rgb(132, 32, 41);"><strong>Low Capability &amp; High Criticality</strong><ul><li>Shift Supervision</li><li>Process Engineering</li><li>Project Engineering</li><li>Quality Assurance</li></ul></div><div style="flex: 1 0 45%; border: 1px solid rgb(221, 221, 221); margin: 4px; padding: 4px; background-color: rgb(215, 231, 211); color: rgb(0, 68, 0);"><strong>High Capability &amp; Low Criticality</strong><span> none</span></div><div style="flex: 1 0 45%; border: 1px solid rgb(221, 221, 221); margin: 4px; padding: 4px; background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);"><strong>Low Capability &amp; Low Criticality</strong><ul><li>Production Manager Wood Yard</li></ul></div></div></div><div class="summary-card"><h2>Retention Risk vs Criticality (Quadrants)</h2><div style="display: flex; flex-wrap: wrap;"><div style="flex: 1 0 45%; border: 1px solid rgb(221, 221, 221); margin: 4px; padding: 4px; background-color: rgb(248, 215, 218); color: rgb(132, 32, 41);"><strong>High Retention Risk &amp; High Criticality</strong><ul><li>Operations Manager</li><li>Shift Supervision</li><li>Production Manager Fiber</li><li>Production manager Recovery or Alkali</li><li>Production manager Utilities</li><li>Environmental Services</li><li>Process Engineering</li><li>Pulp-Specific Maintenance</li><li>Maintenance &amp; Reliability</li><li>Health Safety &amp; Environment</li></ul></div><div style="flex: 1 0 45%; border: 1px solid rgb(221, 221, 221); margin: 4px; padding: 4px; background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);"><strong>Low Retention Risk &amp; High Criticality</strong><ul><li>Project Engineering</li><li>Quality Assurance</li></ul></div><div style="flex: 1 0 45%; border: 1px solid rgb(221, 221, 221); margin: 4px; padding: 4px; background-color: rgb(255, 245, 214); color: rgb(138, 109, 0);"><strong>High Retention Risk &amp; Low Criticality</strong><ul><li>Production Manager Wood Yard</li></ul></div><div style="flex: 1 0 45%; border: 1px solid rgb(221, 221, 221); margin: 4px; padding: 4px; background-color: rgb(215, 231, 211); color: rgb(0, 68, 0);"><strong>Low Retention Risk &amp; Low Criticality</strong><span> none</span></div></div></div><div class="summary-card"><h2>Overall Risk Distribution</h2><canvas height="260" width="400"></canvas></div><div class="summary-card"><h2>Roles by Risk Level</h2><div><div><strong>Critical:</strong><ul><li>Operations Manager -&gt; Buy</li></ul></div><div><strong>High:</strong><ul><li>Shift Supervision -&gt; Build</li><li>Production Manager Fiber -&gt; Build</li><li>Production manager Recovery or Alkali -&gt; Build</li><li>Production manager Utilities -&gt; Build</li><li>Pulp-Specific Maintenance -&gt; Bot</li><li>Maintenance &amp; Reliability -&gt; Build</li><li>Health Safety &amp; Environment -&gt; Build</li></ul></div><div><strong>Medium:</strong><ul><li>Environmental Services -&gt; Build</li><li>Process Engineering -&gt; Build</li><li>Project Engineering -&gt; Unset</li><li>Quality Assurance -&gt; Unset</li></ul></div><div><strong>Low:</strong><span> none</span></div><div><strong>Unset:</strong><ul><li>Production Manager Wood Yard -&gt; Unset</li></ul></div></div></div></div>
</div> <!-- end of siteContent -->
<!-- Seed data embedded from Excel (JSON format) -->
<script id="seed-data" type="application/json">{"rows":[{"department":"Pulp-Mill Specifc Departments","cluster":"Operations Leadership","roleArea":"Operations Manager","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":1,"capabilityComment":"\u2022 Senior manager may retire within a year; no successor identified\\n\u2022 Role is critical for safety and plant leadership\\n\u2022 Bob E has 30 years in pulp/paper mills; limited external industry exposure","retentionRisk":"H","retentionComment":"\u2022 No internal successor identified\\n\u2022 Loss would reduce mill knowledge and leadership continuity","comments":"","preferredMethod":"-","gapMethodComment":""},{"department":null,"cluster":null,"roleArea":"Shift Supervision","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":1,"capabilityComment":"\u2022 In a crisis: follow procedures, decide quickly, communicate clearly\\n\u2022 Supervisors are strong in their own areas but lack whole\u2011system knowledge\\n\u2022 Chance to strengthen leadership and day\u2011to\u2011day organization","retentionRisk":"M","retentionComment":"\u2022 Role is relatively easy to hire; attractive schedule helps recruitment\\n\u2022 Loss of supervisor disrupts crew communication and area management","comments":"","preferredMethod":"-","gapMethodComment":""},{"department":null,"cluster":"Production Management woodyard and fiber line","roleArea":"Production Manager Wood Yard","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":1,"capabilityComment":"\u2022 Area is mechanical and straightforward; safety is the key risk (heavy equipment)\\n\u2022 Role is important and improving performance\\n\u2022 David is a capable manager building strong pulp\u2011mill knowledge","retentionRisk":"M","retentionComment":"\u2022 Easiest part of process; good for developing new leaders\\n\u2022 Loss has limited impact since area is straightforward","comments":"","preferredMethod":"-","gapMethodComment":""},{"department":null,"cluster":null,"roleArea":"Production Manager Fiber","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":null,"capabilityComment":"\u2022 Pulping/washing knowledge takes time to build; poor maintenance risks digesters\\n\u2022 Position is important and making daily improvements\\n\u2022 David is a strong area manager gaining pulp\u2011mill experience","retentionRisk":"H","retentionComment":"\u2022 Mill has experienced person in role but weak pipeline for future replacements\\n\u2022 Loss of David would slow continuous improvement in systems, operations, and accountability","comments":"This role takes years to learn due to combination of chemistry and mechanical knowledge required.","preferredMethod":"-","gapMethodComment":""},{"department":null,"cluster":"Recovery and Utilities","roleArea":"Production manager Recovery or Alkali","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":1,"capabilityComment":"\u2022 Most complex, high\u2011risk process; 5+ years to become proficient\\n\u2022 Scarce expertise; retention is essential\\n\u2022 Jim has strong recovery experience; very few qualified candidates available","retentionRisk":"H","retentionComment":"\u2022 Mills have experienced person in role but little replacement pipeline\\n\u2022 Loss of Jim would leave a gap in experience and hinder process improvement","comments":"Very limited market due to number of pulp mills locally and beyond.","preferredMethod":"-","gapMethodComment":""},{"department":null,"cluster":null,"roleArea":"Production manager Utilities","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":1,"capabilityComment":"\u2022 Same difficult, high\u2011risk process; long learning curve and scarce talent\\n\u2022 Critical due to safety/environment impact\\n\u2022 Alex knows utilities and the mill well; strong upside","retentionRisk":"H","retentionComment":"\u2022 Mills have experienced person in role but little replacement pipeline\\n\u2022 Loss of Alex would challenge primary manufacturing and reduce future bench strength","comments":"Very limited market due to number of pulp mills locally and beyond.","preferredMethod":"-","gapMethodComment":""},{"department":null,"cluster":null,"roleArea":"Environmental Services","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":1,"capabilityComment":"\u2022 Basic operation if sewer losses are avoided\\n\u2022 Role is critical due to regulatory impact on operations/costs\\n\u2022 Eliza shows strong leadership potential\\n\u2022 Aimee is developing well as environmental manager\\n\u2022 Barb is a very good environmental engineer","retentionRisk":"M","retentionComment":"\u2022 Role relatively easy to hire; skills similar to municipal waste plants\\n\u2022 Loss of ETP/Env Manager would reduce system understanding and create team knowledge gaps","comments":"","preferredMethod":"-","gapMethodComment":""},{"department":null,"cluster":"Process Engineering","roleArea":"Process Engineering","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":1,"capabilityComment":"\u2022 More automation would improve performance and reduce costs\\n\u2022 Build and retain pulp\u2011operations expertise; market supply is thin\\n\u2022 Frank is strong in recovery and worth investing in\\n\u2022 Seth is early\u2011career with high potential\\n\u2022 Everett has some pulp\u2011mill experience; needs development","retentionRisk":"H","retentionComment":"\u2022 Difficult skillset to hire; automation expertise in high demand\\n\u2022 Loss of process engineering manageable but slows CI progress and reduces bench strength","comments":"","preferredMethod":"-","gapMethodComment":""},{"department":null,"cluster":"Maintenance","roleArea":"Pulp-Specific Maintenance","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":1,"capabilityComment":"\u2022 Maintenance of boilers, kilns, turbines, and pressure vessels has been inadequate\\n\u2022 Causes: limited funds and knowledge gaps\\n\u2022 Reliability must improve in people and systems\\n\u2022 Nate B is a strong maintenance manager; Sheldon experienced with upside; Todd new with potential\\n\u2022 Planners are solid; systems improving; maintenance software is weak","retentionRisk":"H","retentionComment":"\u2022 Few experienced maintenance leaders with pulp-mill background\\n\u2022 Loss would slow reliability improvements","comments":"","preferredMethod":"-","gapMethodComment":""},{"department":"Shared with Papermill","cluster":"Maintenance & Reliability","roleArea":"Maintenance & Reliability","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":1,"capabilityComment":"\u2022 Reliability remains a priority\\n\u2022 Steve M is building reliability expertise\\n\u2022 Brad B is a strong electrical engineer with deep experience\\n\u2022 Reliability engineers are few and still developing","retentionRisk":"H","retentionComment":"\u2022 Current reliability leadership inconsistent\\n\u2022 Loss manageable short term but increases long-term failure risk","comments":"","preferredMethod":"-","gapMethodComment":""},{"department":null,"cluster":"Project Engineering","roleArea":"Project Engineering","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":1,"capabilityComment":"\u2022 Lower overall risk/impact than mill\u2011specific teams","retentionRisk":"H","retentionComment":"\u2022 Impactful but replaceable using contracted engineers if needed","comments":"","preferredMethod":"-","gapMethodComment":""},{"department":null,"cluster":"Health Safety & Environment","roleArea":"Health Safety & Environment","criticality":1,"capTech":1,"capExperience":1,"capCrisis":1,"capLeadComm":1,"capSafety":1,"capabilityComment":"\u2022 Safety improvement is a clear focus\\n\u2022 Keep the safety team strong and consistent\\n\u2022 Frank is an experienced, effective safety leader\\n\u2022 Other specialists are inexperienced; recruiting skilled safety specialists is difficult","retentionRisk":"M","retentionComment":"\u2022 Losing safety specialist slows overall safety improvement","comments":"","preferredMethod":"-","gapMethodComment":""}]}</script>
<!-- Default numeric values for Mosinee loaded from the provided Excel. Each entry corresponds to a role and contains
       only the numeric capability dimensions, criticality, retention risk and identifiers. Comments and preferred
       method fields are left empty so they can be filled in during the workshop. These arrays are used as the
       starting point when first loading a site or when resetting data back to defaults. -->
<script id="mosinee-default" type="application/json">[{"department":"Pulp-Mill Specifc Departments","cluster":"Operations Leadership","roleArea":"Operations Manager","criticality":3,"capTech":2,"capExperience":3,"capCrisis":2,"capLeadComm":2,"capSafety":2,"retentionRisk":"M","capabilityComment":"No internal successor\nCritical for plant leadership/safety\nLimited financial expertise in pipeline\nGaps in accountability/team guidance\nReactive; lacks strategic vision\nWeak safety culture\nProduction prioritised over safety\nKnowledge gap: Water & Power","retentionComment":"Position vacant; backfill needed\nNo succession plan","comments":"","preferredMethod":"Buy","gapMethodComment":"Hiring due to force exit of previous Ops Manager. Currently managed by existing team and considered low risk.\n\nExternal search in progress, in addition, considering internal move for Ryan from May (due to personal circumstances). Need to assess fit as part of the process.\n\nChanges needed:\nLeaders with to bring a stronger vision and execution of improvement plan.\nOperational improvement require changes in systems (process / technology / ways of working). Short-term external support could be useful, but longer term CI needed for implementation.","id":0,"capabilityAvg":2.2,"capabilityBucket":2,"overallRisk":"High"},{"department":null,"cluster":null,"roleArea":"Shift Supervision","criticality":3,"capTech":2,"capExperience":2,"capCrisis":2,"capLeadComm":2,"capSafety":2,"retentionRisk":"L","capabilityComment":"- Crisis management: Follow procedures, decide, communicate\n- Strong troubleshooters; advocate for hourly staff\n- Lack proactive approach\n- Struggle balancing relationships with leadership\n- Hesitant to challenge upward\n- Change-resistant\n- Limited upward support affects coaching ability\n- Inconsistent safety practices\n- Easy to recruit; attractive 12-hour schedule","retentionComment":"- One approaching retirement","comments":"","preferredMethod":"Build","gapMethodComment":"1 Shift supervisor role open and in recruitment process. \n\nAdditional training and development needed to strengthen people management skill (could be cross-plant effort).","id":1,"capabilityAvg":2,"capabilityBucket":2,"overallRisk":"Medium"},{"department":null,"cluster":"Production Management woodyard and fiber line","roleArea":"Production Manager Wood Yard","criticality":1,"capTech":2,"capExperience":2,"capCrisis":1,"capLeadComm":2,"capSafety":2,"retentionRisk":"L","capabilityComment":"- Easiest area; mechanical focus\n- Safety critical (heavy equipment)\n- Manager: Calm, logical, proactive\n- Extensive woodyard experience\n- Strong relationships\n- Clear expectations; weak documentation/discipline\n- Good for developing new leaders\n- Could hire engineer if needed","retentionComment":"- Succession planning needed","comments":"","preferredMethod":"-","gapMethodComment":"Organisation could be changed to have this lead by a process engineer (more junior). Low risk area.","id":2,"capabilityAvg":1.8,"capabilityBucket":2,"overallRisk":"Low"},{"department":null,"cluster":null,"roleArea":"Production Manager Fiber","criticality":3,"capTech":2,"capExperience":1,"capCrisis":2,"capLeadComm":2,"capSafety":2,"retentionRisk":"M","capabilityComment":"- Pulping/washing requires long development\n- Major digester safety risk\n- Manager drives continuous improvement\n- Strong LOTO/MOC practices\n- Chemical Engineer\n- Excellent technical; developing leadership\n- Process control/centre-lining expertise\n- Highly marketable skills\n- Long ramp-up time\n- Weak replacement pipeline\n- Difficult to fill","retentionComment":"- Focus on retention (scarce skills)","comments":"","preferredMethod":"Bot","gapMethodComment":"Currently this is a very manual process. Large opportunity to improve systems and automation. Could start seeing results within 18 months.\n\nFor capablity building a plan is needed. Could consider external can help, e.g., Tom (someone that really understand liquor cycle). Cross training with Thilmany.\n\nNeed to assess retirement intentions of incumbent and need strong succession building plan.","id":3,"capabilityAvg":1.8,"capabilityBucket":2,"overallRisk":"High"},{"department":null,"cluster":"Recovery and Utilities","roleArea":"Production manager Recovery or Alkali","criticality":3,"capTech":2,"capExperience":3,"capCrisis":2,"capLeadComm":3,"capSafety":2,"retentionRisk":"M","capabilityComment":"- Most complex/highest risk process\n- 5+ years to proficiency\n- Few market candidates\n- Strong team-builder\n- Clear communicator\n- Critical for Alkali investment\n- Respected; values safety\n- Minimal replacement pipeline\n- Must train internally\n- Limited regional market","retentionComment":"- Essential to retain\n- 5-year retirement window\n- No succession options","comments":"","preferredMethod":"Build","gapMethodComment":"Significant retention risk due to high demand / low supply of specialist talent. Need retention conversation and potential retention plan. Individual looking fir more opportunities, driving complex projects. Should also be assessed for Ope Manager role.\n\nBelow only one potential successor and no other bench strength.","id":4,"capabilityAvg":2.4,"capabilityBucket":2,"overallRisk":"High"},{"department":null,"cluster":null,"roleArea":"Production manager Utilities","criticality":3,"capTech":3,"capExperience":3,"capCrisis":2,"capLeadComm":2,"capSafety":2,"retentionRisk":"M","capabilityComment":"- Most complex/highest risk\n- 5+ years to proficiency\n- Few market candidates\n- Paper Science Engineer\n- Deep systems knowledge\n- Logical approach\n- Avoids confrontation\n- High personal standards\n- Minimal pipeline\n- Flight risk (education/local opportunities)","retentionComment":"- Essential to retain\n- No succession options\n- Difficult to fill\n- 5-7 year retirement window","comments":"","preferredMethod":"-","gapMethodComment":"Same person as above.","id":5,"capabilityAvg":2.4,"capabilityBucket":2,"overallRisk":"High"},{"department":null,"cluster":null,"roleArea":"Environmental Services","criticality":1,"capTech":3,"capExperience":3,"capCrisis":2,"capLeadComm":2,"capSafety":2,"retentionRisk":"M","capabilityComment":"- Basic if sewer losses controlled\n- Easy to recruit\n- Equipment similar to municipal plants","retentionComment":"- Monitor needs","comments":"","preferredMethod":"Bot","gapMethodComment":"Opportunity to revise the structure, this is more operator level.","id":6,"capabilityAvg":2.4,"capabilityBucket":2,"overallRisk":"Low"},{"department":null,"cluster":"Process Engineering","roleArea":"Process Engineering","criticality":3,"capTech":2,"capExperience":1,"capCrisis":2,"capLeadComm":2,"capSafety":2,"retentionRisk":"H","capabilityComment":"- Automation improves performance/costs\n- Young engineer, 2-year controls degree\n- Fast learner; quickly relied upon\n- Strong under pressure\n- Difficult to recruit\n- Automation expertise in demand\n- Understaffed; single person\n- Highly marketable\n- Growth-oriented\n- Relocatable","retentionComment":"- Focus on retention (scarce skills)","comments":"","preferredMethod":"Build","gapMethodComment":"Retention - likely to go back to school, full or part time. No succession plan. Not aware of plans to leave but big risk.\n\nNeed to build this strength.\n\nCould look at structure and use these for some of the other roles.\n\nNeed to build their CI skills.","id":7,"capabilityAvg":1.8,"capabilityBucket":2,"overallRisk":"Critical"},{"department":null,"cluster":"Maintenance","roleArea":"Pulp-Specific Maintenance","criticality":3,"capTech":2,"capExperience":3,"capCrisis":2,"capLeadComm":2,"capSafety":3,"retentionRisk":"L","capabilityComment":"- Inadequate maintenance (vessels, boilers, turbines, kilns)\n- Causes: Limited funds/knowledge\n- Team knowledgeable but underutilised\n- Operations Manager creates barriers\n- Transferable/marketable skills","retentionComment":"- Monitor needs","comments":"","preferredMethod":"-","gapMethodComment":"Some people retiring, but good bench strength underneath.","id":8,"capabilityAvg":2.4,"capabilityBucket":2,"overallRisk":"Medium"},{"department":"Shared with Papermill","cluster":"Maintenance & Reliability","roleArea":"Maintenance & Reliability","criticality":3,"capTech":3,"capExperience":2,"capCrisis":1,"capLeadComm":2,"capSafety":2,"retentionRisk":"M","capabilityComment":"- Team knowledgeable but underutilised\n- Operations Manager creates barriers\n- Transferable/marketable skills","retentionComment":"- Monitor needs","comments":"","preferredMethod":"Build","gapMethodComment":"Keep training.\n\nNeed to develop strong training plans (could be cross-plant initiative) \n\nBig capacity issue due to limited resources: Example, when we have failure we don't have enough capacity. Not enough reliability work, we need to have this capacity for at least a few years. Could be cross-plant.","id":9,"capabilityAvg":2,"capabilityBucket":2,"overallRisk":"High"},{"department":null,"cluster":"Project Engineering","roleArea":"Project Engineering","criticality":2,"capTech":3,"capExperience":2,"capCrisis":2,"capLeadComm":3,"capSafety":3,"retentionRisk":"M","capabilityComment":"- Strongest mill team\n- Strained leadership relationship\n- Transferable/marketable skills\n- Young, educated team","retentionComment":"- Monitor needs","comments":"","preferredMethod":"Build","gapMethodComment":"","id":10,"capabilityAvg":2.6,"capabilityBucket":3,"overallRisk":"Medium"},{"department":null,"cluster":"Health Safety & Environment","roleArea":"Health Safety & Environment","criticality":3,"capTech":1,"capExperience":2,"capCrisis":2,"capLeadComm":2,"capSafety":3,"retentionRisk":"H","capabilityComment":"- Significant LOTO system progress\n- Fostering mill-wide safety engagement\n- Multiple hourly rotations","retentionComment":"- Safety Manager departing","comments":"","preferredMethod":"Buy","gapMethodComment":"Open position","id":12,"capabilityAvg":2,"capabilityBucket":2,"overallRisk":"Critical"}]</script>
<!-- Default numeric values for Thilmany loaded from the provided Excel. See above for details. -->
<script id="thilmany-default" type="application/json">[{"department":"Pulp-Mill Specifc Departments","cluster":"Operations Leadership","roleArea":"Operations Manager","criticality":3,"capTech":2,"capExperience":2,"capCrisis":2,"capLeadComm":2,"capSafety":3,"retentionRisk":"H","capabilityComment":"- Critical for safety/leadership\n- Bob E: 30 years experience, limited external exposure\n- No internal successor\n- Loss reduces institutional knowledge","retentionComment":"- Retirement risk","comments":"","preferredMethod":"Buy","gapMethodComment":"Hiring due to planned retirement of previous Ops Manager. Offer out and expected to be accepted. Currently managed by existing team and considered low risk.\n\nChanges needed:\nLeaders with to bring a stronger vision and execution of improvement plan.\nOperational improvement require changes in systems (process / technology / ways of working). Short-term external support could be useful, but longer term CI needed for implementation.","id":0,"capabilityAvg":2.2,"capabilityBucket":2,"overallRisk":"Critical"},{"department":null,"cluster":null,"roleArea":"Shift Supervision","criticality":3,"capTech":1,"capExperience":2,"capCrisis":1,"capLeadComm":2,"capSafety":2,"retentionRisk":"M","capabilityComment":"Crisis: Follow procedures, decide quickly, communicate\nStrong in individual areas; lack system knowledge\nNeed stronger leadership/organisation\nEasy to recruit; attractive schedule\nLoss disrupts crew management\nLow Technical knowledge\nLow Crisis management","retentionComment":"Monitor needs","comments":"","preferredMethod":"Build","gapMethodComment":"Crisis management - this needs to be developed internally with system improvements (new Ops Manager must lead this work).\n\nTechnical knowledge need needs to be build it, training or selected hires - potential cross plant effort (not Mosinee has these skills).","id":1,"capabilityAvg":1.6,"capabilityBucket":2,"overallRisk":"High"},{"department":null,"cluster":"Production Management woodyard and fiber line","roleArea":"Production Manager Wood Yard","criticality":0,"capTech":null,"capExperience":0,"capCrisis":0,"capLeadComm":null,"capSafety":null,"retentionRisk":"-","capabilityComment":"Mechanical/straightforward\nSafety key risk (heavy equipment)\nDavid: Capable, building pulp knowledge\nGood for developing leaders\nLimited impact if lost","retentionComment":"Monitor needs","comments":"","preferredMethod":"-","gapMethodComment":"Automated, role does not exist.","id":2,"capabilityAvg":0,"capabilityBucket":1,"overallRisk":null},{"department":null,"cluster":null,"roleArea":"Production Manager Fiber","criticality":3,"capTech":2,"capExperience":2,"capCrisis":2,"capLeadComm":2,"capSafety":3,"retentionRisk":"M","capabilityComment":"Pulping/washing requires long development\nDigester safety critical\nDavid: Strong, gaining experience\nWeak replacement pipeline\nLoss slows improvement","retentionComment":"Focus on retention","comments":"","preferredMethod":"Build","gapMethodComment":"Currently this is a very manual process. Large opportunity to improve systems and automation. Could start seeing results within 18 months.\n\nFor capablity building a plan is needed. Could consider external can help, e.g., Tom (someone that really understand liquor cycle). Cross training with Mosinee.\n\nNeed to assess retirement intentions of incumbent and need strong succession building plan.","id":3,"capabilityAvg":2.2,"capabilityBucket":2,"overallRisk":"High"},{"department":null,"cluster":"Recovery and Utilities","roleArea":"Production manager Recovery or Alkali","criticality":3,"capTech":2,"capExperience":3,"capCrisis":2,"capLeadComm":3,"capSafety":2,"retentionRisk":"M","capabilityComment":"- Complex/high-risk; 5+ years to proficiency\n- Jim: Strong recovery experience\n- Few qualified candidates\n- Limited pipeline\n- Loss creates experience gap","retentionComment":"- Essential (scarce expertise)","comments":"","preferredMethod":"Build","gapMethodComment":"Significant retention risk due to high demand / low supply of specialist talent. Need retention conversation and potential retention plan. Also need to evaluate retirement risk \n\nNeed plan to develop successors.","id":4,"capabilityAvg":2.4,"capabilityBucket":2,"overallRisk":"High"},{"department":null,"cluster":null,"roleArea":"Production manager Utilities","criticality":3,"capTech":2,"capExperience":2,"capCrisis":2,"capLeadComm":2,"capSafety":2,"retentionRisk":"M","capabilityComment":"- Complex/high-risk; long learning curve\n- Critical for safety/environmental\n- Alex: Knows utilities well; strong potential\n- Limited pipeline","retentionComment":"- Loss challenges manufacturing/bench strength","comments":"","preferredMethod":"Build","gapMethodComment":"Need stay conversation and retention plan. Stay conversation to figure out what he wants.","id":5,"capabilityAvg":2,"capabilityBucket":2,"overallRisk":"High"},{"department":null,"cluster":null,"roleArea":"Environmental Services","criticality":2,"capTech":2,"capExperience":2,"capCrisis":2,"capLeadComm":2,"capSafety":2,"retentionRisk":"M","capabilityComment":"- Basic if sewer losses controlled\n- Critical for regulatory compliance\n- Eliza: Strong leadership potential\n- Aimee: Developing well\n- Barb: Competent engineer\n- Easy to recruit\n- Loss reduces system knowledge","retentionComment":"- Focus on retention","comments":"","preferredMethod":"Build","gapMethodComment":"Retention - stay conversation. Could develop further if interested. Define development plan.","id":6,"capabilityAvg":2,"capabilityBucket":2,"overallRisk":"Medium"},{"department":null,"cluster":"Process Engineering","roleArea":"Process Engineering","criticality":2,"capTech":2,"capExperience":1,"capCrisis":1,"capLeadComm":2,"capSafety":2,"retentionRisk":"M","capabilityComment":"Automation improves performance/costs\nFrank: Strong recovery\nSeth: Early-career, high potential\nEverett: Some experience, needs development\nDifficult to recruit\nLow Experience\nLow Crisis management","retentionComment":"Build/retain expertise (limited supply)\nLoss slows improvement","comments":"","preferredMethod":"Build","gapMethodComment":"Keep building skills and retention plan.","id":7,"capabilityAvg":1.6,"capabilityBucket":2,"overallRisk":"Medium"},{"department":null,"cluster":"Maintenance","roleArea":"Pulp-Specific Maintenance","criticality":3,"capTech":2,"capExperience":2,"capCrisis":2,"capLeadComm":2,"capSafety":2,"retentionRisk":"M","capabilityComment":"- Inadequate maintenance (boilers, kilns, turbines, vessels)\n- Limited funds/knowledge\n- Need reliability improvement\n- Nate B: Strong manager\n- Sheldon: Experienced, upside\n- Todd: New, potential\n- Planners solid; weak software\n- Few experienced leaders\n- Loss slows improvements","retentionComment":"- Focus on retention","comments":"","preferredMethod":"Bot","gapMethodComment":"Maintenance IT systems need improvement.\n\nRetention plans.","id":8,"capabilityAvg":2,"capabilityBucket":2,"overallRisk":"High"},{"department":"Shared with Papermill","cluster":"Maintenance & Reliability","roleArea":"Maintenance & Reliability","criticality":3,"capTech":2,"capExperience":2,"capCrisis":2,"capLeadComm":2,"capSafety":2,"retentionRisk":"M","capabilityComment":"- Reliability priority\n- Steve M: Building expertise\n- Brad B: Strong electrical engineer\n- Few reliability engineers\n- Inconsistent leadership\n- Loss manageable short-term; increases long-term risk","retentionComment":"- Focus on retention","comments":"","preferredMethod":"Build","gapMethodComment":"Keep training.\n\nNeed to develop strong training plans (could be cross-plant initiative) \n\nBig capacity issue due to limited resources: Example, when we have failure we don't have enough capacity. Not enough reliability work, we need to have this capacity for at least a few years. Could be cross-plant.","id":9,"capabilityAvg":2,"capabilityBucket":2,"overallRisk":"High"},{"department":null,"cluster":"Project Engineering","roleArea":"Project Engineering","criticality":2,"capTech":2,"capExperience":2,"capCrisis":1,"capLeadComm":2,"capSafety":2,"retentionRisk":"L","capabilityComment":"- Lower risk than operations\n- Replaceable with contractors if needed","retentionComment":"- Monitor needs","comments":"","preferredMethod":"-","gapMethodComment":"","id":10,"capabilityAvg":1.8,"capabilityBucket":2,"overallRisk":"Medium"},{"department":null,"cluster":"Health Safety & Environment","roleArea":"Health Safety & Environment","criticality":3,"capTech":2,"capExperience":2,"capCrisis":2,"capLeadComm":2,"capSafety":3,"retentionRisk":"M","capabilityComment":"- Safety improvement focus\n- Frank: Experienced, effective leader\n- Other specialists inexperienced\n- Recruiting difficult\n- Loss slows safety improvement","retentionComment":"- Focus on retention","comments":"","preferredMethod":"Build","gapMethodComment":"Develop people underneath.\n\nCross-mill sharing.","id":12,"capabilityAvg":2.2,"capabilityBucket":2,"overallRisk":"High"}]</script>
<script>
    // ============================================================================
    // CRITICAL FIX: Define ALL functions in global scope FIRST
    // This ensures they work in saved HTML files
    // ============================================================================
    
    // Global variables
    var currentSite = null;
    var siteParam = 'default';
    var storageBasePrefix = 'mill_skills_';
    var storageKey = storageBasePrefix + siteParam;
    var rows = [];
    var summaryVisible = false;
    var currentUserName = '';
    var currentPopover = null;
    var editingCell = null;
    var consolidatedData = [];
    var selectedFiles = [];
// Guard to ensure initialization happens only once. Without this,
// initializeApplication() may run multiple times due to both the
// DOMContentLoaded handler and the fallback timeout invocation. When
// initialization attaches event listeners multiple times, UI controls
// like the summary toggle can malfunction. This flag prevents duplicate
// initialization.
var appInitialized = false;
    
    // Critical navigation functions - defined globally
    function showStart() {
      if (typeof commitEditing === 'function') {
        commitEditing();
      }
      var siteDiv = document.getElementById('siteContent');
      var startDiv = document.getElementById('startView');
      var consDiv = document.getElementById('consolidationView');
      if (siteDiv) siteDiv.style.display = 'none';
      if (startDiv) startDiv.style.display = '';
      if (consDiv) consDiv.style.display = 'none';
    }
    
    function showConsolidation() {
      if (typeof commitEditing === 'function') {
        commitEditing();
      }
      var startDiv = document.getElementById('startView');
      var siteDiv = document.getElementById('siteContent');
      var consDiv = document.getElementById('consolidationView');
      if (startDiv) startDiv.style.display = 'none';
      if (siteDiv) siteDiv.style.display = 'none';
      if (consDiv) consDiv.style.display = '';
    }
    
    function startSite(siteName) {
      var nameEl = document.getElementById('startUserName');
      var userName = nameEl ? nameEl.value.trim() : '';
      if (!userName) {
        alert('Please enter your name before starting.');
        return;
      }
      currentUserName = userName;
      if (typeof commitEditing === 'function') {
        commitEditing();
      }
      // Call the IIFE-exported loadSite on the global window.  The main
      // application defines loadSite inside an IIFE and then attaches it
      // to window via ensureGlobalFunctions().  In some cases the function
      // may not yet be available when users click a site button.  To avoid
      // silent failure, check window.loadSite and defer briefly if
      // necessary.  This prevents the application from appearing to be
      // "not fully loaded" when the user clicks quickly.
      if (typeof window.loadSite === 'function') {
        window.loadSite(siteName);
      } else {
        // Defer and retry once to allow ensureGlobalFunctions to run
        setTimeout(function() {
          if (typeof window.loadSite === 'function') {
            window.loadSite(siteName);
          } else {
            // As a last resort, display a helpful message.  The fallback
            // script will also show an alert if loadSite is never defined.
            alert('Application not fully loaded. Please refresh the page and try again.');
          }
        }, 50);
        // Do not proceed to change views until loadSite is called
        return;
      }
      var startDiv = document.getElementById('startView');
      var consDiv = document.getElementById('consolidationView');
      var siteDiv = document.getElementById('siteContent');
      if (startDiv) startDiv.style.display = 'none';
      if (consDiv) consDiv.style.display = 'none';
      if (siteDiv) siteDiv.style.display = '';
      summaryVisible = false;
      var summaryBtn = document.getElementById('toggleSummary');
      if (summaryBtn) summaryBtn.textContent = 'Show Summary';
    }
    
    function downloadAllCSV() {
      // Delegate to a global implementation if one has been attached by the
      // main application.  The early script defines a stub for this
      // function, but once the main app loads it will assign
      // window.downloadAllCSV.  We detect that case here and forward
      // the call rather than raising the stub alert again.  Without this
      // check, saved versions of the tool may display the placeholder
      // message instead of performing the real download.
      if (window.downloadAllCSV && window.downloadAllCSV !== downloadAllCSV) {
        return window.downloadAllCSV();
      }
      alert('Downloading all CSV data...');
      // Implementation to be added by main code
    }
    
    function saveCurrentVersion() {
      // If the main application has attached a more complete implementation
      // to window.saveCurrentVersion, delegate to that version.  This check
      // prevents the stub from overriding the real save logic when running
      // in the original unsaved tool or in a saved copy where the IIFE has
      // already replaced window.saveCurrentVersion.  It also helps avoid
      // the "Application not fully loaded" message appearing when users
      // click the Save button before the main script has finished loading.
      if (window.saveCurrentVersion && window.saveCurrentVersion !== saveCurrentVersion) {
        return window.saveCurrentVersion();
      }
      alert('Saving current version...');
      // Implementation to be added by main code
    }
    
    function resetData() {
      // Forward to a real resetData implementation if one has been attached
      // to window by the main application.  This prevents the stub from
      // overriding the real logic once it becomes available.
      if (window.resetData && window.resetData !== resetData) {
        return window.resetData();
      }
      if (confirm('Are you sure you want to reset all data to defaults?')) {
        alert('Data reset to defaults.');
        // Implementation to be added by main code
      }
    }
    
    // ============================================================================
    // MAIN APPLICATION - wrapped in IIFE but functions already globally defined
    // ============================================================================
    (function() {

      // Utility functions for calculations
      function computeCapabilityAvg(row) {
        // Coerce numeric values to numbers before averaging. If any cell is
        // provided as a string (e.g. "3"), addition on strings can lead to
        // concatenation which breaks averaging. Cast to floats here.
        const rawVals = [row.capTech, row.capExperience, row.capCrisis, row.capLeadComm, row.capSafety];
        const vals = rawVals.filter(v => v !== null && v !== undefined).map(v => {
          // parseInt may return NaN for empty strings; fallback to null
          const num = typeof v === 'string' ? parseFloat(v) : v;
          return isNaN(num) ? null : num;
        }).filter(v => v !== null);
        if (!vals.length) return null;
        const sum = vals.reduce((a, b) => a + b, 0);
        return sum / vals.length;
      }
      function bucketCapability(avg) {
        if (avg === null) return null;
        if (avg >= 2.5) return 3;
        if (avg >= 1.5) return 2;
        return 1;
      }
      function mapRetentionNum(val) {
        if (!val || val === '-') return null;
        if (val === 'L') return 1;
        if (val === 'M') return 2;
        if (val === 'H') return 3;
        return null;
      }
      function computeOverallRisk(row) {
        /*
         * Overall risk mapping derived from the criticality map document. The
         * overall risk is determined by combining the role's criticality (1 =
         * Low, 2 = Medium, 3 = High) with its capability bucket (1 = Low,
         * 2 = Medium, 3 = High) and retention risk (L/M/H mapped to 1/2/3).
         * Missing capability values default to High (3) and missing
         * retention risk defaults to Low (1) to avoid penalising unknowns.
         *
         * The mapping for each criticality level is:
         *
         * Criticality = High (3):
         *   cap\ret  1    2        3
         *    3      Low  Medium   High
         *    2     Medium High    Critical
         *    1     High  Critical Critical
         *
         * Criticality = Medium (2):
         *   cap\ret  1    2        3
         *    3      Low  Medium   Medium
         *    2     Medium Medium   High
         *    1     Medium High    High
         *
         * Criticality = Low (1):
         *   cap\ret  1    2        3
         *    3      Low  Low      Low
         *    2      Low  Low     Medium
         *    1      Low  Medium  Medium
         */
        const criticality = row.criticality != null ? Math.round(row.criticality) : null;
        // Default missing capability to high capability (3).  When
        // capabilityBucket is null or undefined we assume the person is fully
        // capable rather than penalising unknowns with the lowest bucket.  See
        // comment above for mapping rationale.
        const capBucket = row.capabilityBucket != null ? row.capabilityBucket : 3;
        // Default missing retention risk to low
        const retNumRaw = mapRetentionNum(row.retentionRisk);
        const ret = retNumRaw != null ? retNumRaw : 1;
        if (!criticality) return null;
        // High criticality
        if (criticality === 3) {
          if (capBucket === 3 && ret === 1) return 'Low';
          if (capBucket === 3 && ret === 2) return 'Medium';
          if (capBucket === 3 && ret === 3) return 'High';
          if (capBucket === 2 && ret === 1) return 'Medium';
          if (capBucket === 2 && ret === 2) return 'High';
          if (capBucket === 2 && ret === 3) return 'Critical';
          if (capBucket === 1 && ret === 1) return 'High';
          if (capBucket === 1 && ret === 2) return 'Critical';
          if (capBucket === 1 && ret === 3) return 'Critical';
        }
        // Medium criticality
        if (criticality === 2) {
          if (capBucket === 3 && ret === 1) return 'Low';
          if (capBucket === 3 && ret === 2) return 'Medium';
          if (capBucket === 3 && ret === 3) return 'Medium';
          if (capBucket === 2 && ret === 1) return 'Medium';
          if (capBucket === 2 && ret === 2) return 'Medium';
          if (capBucket === 2 && ret === 3) return 'High';
          if (capBucket === 1 && ret === 1) return 'Medium';
          if (capBucket === 1 && ret === 2) return 'High';
          if (capBucket === 1 && ret === 3) return 'High';
        }
        // Low criticality
        if (criticality === 1) {
          if (capBucket === 3 && ret === 1) return 'Low';
          if (capBucket === 3 && ret === 2) return 'Low';
          if (capBucket === 3 && ret === 3) return 'Low';
          if (capBucket === 2 && ret === 1) return 'Low';
          if (capBucket === 2 && ret === 2) return 'Low';
          if (capBucket === 2 && ret === 3) return 'Medium';
          if (capBucket === 1 && ret === 1) return 'Low';
          if (capBucket === 1 && ret === 2) return 'Medium';
          if (capBucket === 1 && ret === 3) return 'Medium';
        }
        return null;
      }
      /**
       * Determine which capability dimensions are low (value === 1).
       * Returns an array of strings like "Technical knowledge".
       */
      function getLowDimensions(row) {
        const dims = [];
        if (row.capTech === 1) dims.push('Technical knowledge');
        if (row.capExperience === 1) dims.push('Experience');
        if (row.capCrisis === 1) dims.push('Crisis management');
        if (row.capLeadComm === 1) dims.push('Leadership & Communication');
        if (row.capSafety === 1) dims.push('Safety mindset');
        return dims;
      }
      /**
       * Build a multiline comments string for display in the table.
       * It separates capability and retention comments into their own sections
       * with bullet points. Automatic notes about low capability dimensions are
       * appended to the capability section.
       */
      function displayComments(row) {
        const lines = [];
        // Capability section
        const capLines = [];
        // manual capability comments
        if (row.capabilityComment) {
          row.capabilityComment.split(/\n/).forEach(l => {
            const trimmed = l.trim();
            if (trimmed) {
              // Append capability comments without a leading dash.  Dashes can
              // interfere with consolidation and are unnecessary for simple
              // listing.
              capLines.push(trimmed);
            }
          });
        }
        // Removed auto generated low dimension notes to avoid duplicate comments during merging.
        // Always include a Capability section.  Only add bullet lines if
        // capability comments exist; otherwise leave the section empty.  This
        // avoids inserting placeholder dashes that would pollute consolidated
        // comments.
        lines.push('Capability:');
        if (capLines.length) {
          lines.push(...capLines);
        }
        // Retention section
        const retLines = [];
        if (row.retentionComment) {
          row.retentionComment.split(/\n/).forEach(l => {
            const trimmed = l.trim();
            if (trimmed) {
              // Append retention comments without a leading dash
              retLines.push(trimmed);
            }
          });
        }
        // Insert an extra blank line between capability and retention only if
        // there are capability lines.  This keeps the two sections separate
        // without introducing empty bullets when there are no notes.
        if (capLines.length) {
          lines.push('');
          lines.push('');
        }
        lines.push('Retention:');
        if (retLines.length) {
          lines.push(...retLines);
        }
        // Additional general comments (from original comments field) if provided
        const addLines = [];
        if (row.comments) {
          row.comments.split(/\n/).forEach(l => {
            const trimmed = l.trim();
            if (trimmed) {
                  // Append additional comments without a leading dash
                  addLines.push(trimmed);
            }
          });
        }
        if (addLines.length) {
          // Add a single blank line before Additional section for separation
          lines.push('');
          lines.push('Additional:');
          lines.push(...addLines);
        }
        if (lines.length === 0) return '';
        return lines.join('\n');
      }
      // Parse seed data
      const seedEl = document.getElementById('seed-data');
      const seedJson = JSON.parse(seedEl.textContent);
      // Override the seed data rows to reflect paper mill roles instead of pulp mill roles
      /* Override of seedJson.rows for paper roles is no longer used in this combined tool.
      seedJson.rows = [
        {department: null, cluster: null, roleArea: 'Operations Manager (Paper)', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Supervisor (Shift/Area)', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Production / Area Manager ‚Äì Paper Machine, Finishing & Converting', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Maintenance & Reliability Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Process Engineer', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Project Engineer', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'HSE Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Quality Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'R&D / Technical Services Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Supply Chain Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Logistics & Warehouse Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Continuous Improvement / Lean Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Finance / Plant Controller', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''}
      ];
      */

      // Define the list of mills (sites) for the paper mill assessment.
      // Each site will maintain its own independent data set.
      // Define the list of mills (sites) for the combined pulp and paper assessment.
      // Only three options are available: a pulp-only view, a paper & shared view, and J√∂nk√∂ping.
      const siteNames = [
        'Billingfors Pulp',
        'Billingfors Paper and Shared',
        'J√∂nk√∂ping'
      ];

      // Definitions for each role.  When hovering over a role name in the
      // table, the corresponding definition will appear as a tooltip.  These
      // descriptions describe the core responsibilities of each role in
      // the paper mill.  If a role is not listed here, no tooltip is
      // displayed.
      const roleDefinitions = {
        'Operations Manager (Paper)': 'Production planning and coordination; grade changeovers; stabilising run conditions; KPI control (speed, waste, quality, uptime); cross-shift alignment; clear escalation.',
        'Supervisor (Shift/Area)': 'Front-line leadership; control-room/line operation; safe start-up/shutdown; standard work enforcement; quick escalation; training and performance feedback.',
        'Production / Area Manager ‚Äì Paper Machine, Finishing & Converting': 'High-speed run stability across areas; crew leadership and training; standard work discipline; fast troubleshooting of breaks/defects; safe operations; clean handovers.',
        'Maintenance & Reliability Manager': 'Preventive/predictive programs; rapid breakdown response; root-cause fixes; shutdown/turnaround planning; spares control; reliability and uptime improvement.',
        'Process Engineer': 'Optimising wet end, pressing, drying, calendering; data analysis/SPC; fibre/chemistry tuning; run trials; energy/water reduction; solving chronic losses.',
        'Project Engineer': 'Capex scoping and business cases; equipment spec/selection; installation and commissioning; contractor/vendor control; schedule/cost/risk management; change control.',
        'HSE Manager': 'Compliance and permits; risk assessments and safe systems of work; training and audits; incident investigation and learning; effluent/air/noise monitoring; regulator reporting.',
        'Quality Manager': 'QMS ownership; lab methods and release testing; SPC basics; traceability and certificates; customer complaints/CAPA; supplier quality checks.',
        'R&D / Technical Services Manager': 'New grade development; fibre blends and sizing/coating optimisation; pilot/plant trials and scale-up; customer line support; specs and datasheets.',
        'Supply Chain Manager': 'Pulp/chemical/packaging procurement; inventory and warehouse control; production & delivery planning; logistics coordination; cost-to-serve optimisation.',
        'Logistics & Warehouse Manager': 'Dock/yard operations; carrier management; export docs; roll/pack integrity and damage prevention; layout, picking, cycle counts; on-time dispatch.',
        'Continuous Improvement / Lean Manager': 'Structured problem-solving (A3, 5-Why); process mapping; standard work/visual controls; kaizen facilitation; benefits tracking and verification.',
        'Finance / Plant Controller': 'Costing/variance analysis; budgets/forecasts; inventory valuation/controls; capex cases; compliance; decision support to operations.'
      };

      // Prepare default data sets for each site. These are deep copies of the
      // seed rows and serve as the baseline when first loading or resetting a site.
      /*
       * Define default data for each site.  Rather than cloning the generic
       * seed data for every site, we explicitly set up rows for our three
       * sites.  The pulp rows mirror the structure of the combined pulp
       * assessment but have all numeric ratings set to the lowest level and
       * comments left blank.  The paper rows reflect the paper mill roles with
       * default ratings of 1 (capabilities) and 'M' retention risk.  The
       * sharedRow represents the maintenance & reliability role that is
       * shared between the pulp and paper mills; it is only included on the
       * "Billingfors (Paper and shared)" view.
       */

      // Pulp-specific rows with low criticality/capability and low retention risk
      const pulpRows = [
        {department: 'Pulp-Mill Specifc Departments', cluster: 'Operations Leadership', roleArea: 'Operations Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Shift Supervision', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: 'Production Management woodyard and fiber line', roleArea: 'Production Manager Wood Yard', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Production Manager Fiber', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: 'Recovery and Utilities', roleArea: 'Production manager Recovery or Alkali', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Production manager Utilities', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Environmental Services', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: 'Process Engineering', roleArea: 'Process Engineering', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: 'Maintenance', roleArea: 'Pulp-Specific Maintenance', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: 'Project Engineering', roleArea: 'Project Engineering', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: 'Health Safety & Environment', roleArea: 'Health Safety & Environment', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''}
      ];

      // Paper-specific rows with default capability ratings of 1 and medium retention risk
      const paperRows = [
        {department: null, cluster: null, roleArea: 'Operations Manager (Paper)', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Supervisor (Shift/Area)', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Production / Area Manager ‚Äì Paper Machine, Finishing & Converting', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Maintenance & Reliability Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Process Engineer', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Project Engineer', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'HSE Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Quality Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'R&D / Technical Services Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Supply Chain Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Logistics & Warehouse Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Continuous Improvement / Lean Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Finance / Plant Controller', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''}
      ];

      // Row that is shared between pulp and paper (maintenance & reliability)
      const sharedRow = {department: 'Shared with Papermill', cluster: 'Maintenance & Reliability', roleArea: 'Maintenance & Reliability', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''};

      // Build the default data object for the single unified plant.  We clone the
      // seed rows so that edits do not affect the original seed data.  The
      // previous pulp and paper specific definitions are retained above but
      // unused now that only one plant is supported.
      // Define per-site default data. Each site starts from the appropriate set
      // of seed roles defined above.  All numeric ratings are initialised to 1
      // (lowest) and retention risk is set to Low ("L").  Comments and
      // preferred methods are blank.  The shared maintenance & reliability
      // role is included on the pulp and paper sites but omitted from
      // J√∂nk√∂ping.
      const defaultData = {
        'Billingfors Pulp': (() => {
          const rows = pulpRows.map(r => {
            const obj = Object.assign({}, r);
            obj.criticality = 1;
            obj.capTech = 1;
            obj.capExperience = 1;
            obj.capCrisis = 1;
            obj.capLeadComm = 1;
            obj.capSafety = 1;
            obj.retentionRisk = 'L';
            obj.capabilityComment = '';
            obj.retentionComment = '';
            obj.comments = '';
            obj.preferredMethod = '-';
            obj.gapMethodComment = '';
            return obj;
          });
          const shared = Object.assign({}, sharedRow);
          shared.criticality = 1;
          shared.capTech = 1;
          shared.capExperience = 1;
          shared.capCrisis = 1;
          shared.capLeadComm = 1;
          shared.capSafety = 1;
          shared.retentionRisk = 'L';
          shared.capabilityComment = '';
          shared.retentionComment = '';
          shared.comments = '';
          shared.preferredMethod = '-';
          shared.gapMethodComment = '';
          rows.push(shared);
          return rows;
        })(),
        'Billingfors Paper and Shared': (() => {
          const rows = paperRows.map(r => {
            const obj = Object.assign({}, r);
            obj.criticality = 1;
            obj.capTech = 1;
            obj.capExperience = 1;
            obj.capCrisis = 1;
            obj.capLeadComm = 1;
            obj.capSafety = 1;
            obj.retentionRisk = 'L';
            obj.capabilityComment = '';
            obj.retentionComment = '';
            obj.comments = '';
            obj.preferredMethod = '-';
            obj.gapMethodComment = '';
            return obj;
          });
          const shared = Object.assign({}, sharedRow);
          shared.criticality = 1;
          shared.capTech = 1;
          shared.capExperience = 1;
          shared.capCrisis = 1;
          shared.capLeadComm = 1;
          shared.capSafety = 1;
          shared.retentionRisk = 'L';
          shared.capabilityComment = '';
          shared.retentionComment = '';
          shared.comments = '';
          shared.preferredMethod = '-';
          shared.gapMethodComment = '';
          rows.push(shared);
          return rows;
        })(),
        'J√∂nk√∂ping': (() => {
          const rows = paperRows.filter(r => r.roleArea !== 'Maintenance & Reliability Manager').map(r => {
            const obj = Object.assign({}, r);
            obj.criticality = 1;
            obj.capTech = 1;
            obj.capExperience = 1;
            obj.capCrisis = 1;
            obj.capLeadComm = 1;
            obj.capSafety = 1;
            obj.retentionRisk = 'L';
            obj.capabilityComment = '';
            obj.retentionComment = '';
            obj.comments = '';
            obj.preferredMethod = '-';
            obj.gapMethodComment = '';
            return obj;
          });
          return rows;
        })()
      };

      // If a site-defaults script is present, parse it to override the defaults.
      // This script may contain a JSON object keyed by site name. The content
      // can be plain JSON or base64-encoded JSON. When present, it allows
      // preserving per-site edits when saving the tool.
      try {
        const siteDefaultsEl = document.getElementById('site-defaults');
        if (siteDefaultsEl) {
          let text = siteDefaultsEl.textContent.trim();
          let parsed = null;
          try {
            // Try to parse plain JSON first
            parsed = JSON.parse(text);
          } catch (jsonErr) {
            try {
              // Attempt to decode from base64. Use decodeURIComponent/escape
              // to properly handle Unicode characters if the plain atob fails.
              const decoded = atob(text);
              try {
                parsed = JSON.parse(decoded);
              } catch (innerErr) {
                parsed = JSON.parse(decodeURIComponent(escape(decoded)));
              }
            } catch (b64Err) {
              parsed = null;
            }
          }
          if (parsed && typeof parsed === 'object') {
            Object.keys(parsed).forEach(name => {
              if (Array.isArray(parsed[name])) {
                defaultData[name] = parsed[name].map(r => Object.assign({}, r));
              }
            });
          }
        }
      } catch (e) {
        console.error('Failed to parse custom site defaults', e);
      }
      // Initialize global variables - already declared globally
      // Use a simple storage key prefix rather than a long timestamped prefix.  This allows per-site data to be stored cleanly.

      // Load previously saved data or seed data for the given site. This
      // function is called when loadSite() is invoked.
      function loadRowsForSite() {
        rows = [];
        // Determine whether we loaded data from localStorage. This helps us
        // distinguish between user‚Äësaved data and default starting data.
        let loadedFromStorage = false;
        try {
          const saved = localStorage.getItem(storageKey);
          if (saved) {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed)) {
              parsed.forEach((r) => rows.push(Object.assign({}, r)));
              loadedFromStorage = true;
            }
          }
        } catch (e) {
          // ignore errors and fall back to seed
        }
        // If there is no saved data in storage, fall back to the default
        // starting data for the current site. We prefer site‚Äëspecific
        // defaults from defaultData (Mosinee or Thilmany). If for some
        // reason that data is missing, we use the seed JSON rows as a
        // fallback.
        if (rows.length === 0) {
          const siteDefaults = defaultData[currentSite];
          if (siteDefaults && Array.isArray(siteDefaults)) {
            siteDefaults.forEach((r) => rows.push(Object.assign({}, r)));
          } else if (seedJson.rows && Array.isArray(seedJson.rows)) {
            seedJson.rows.forEach((r) => rows.push(Object.assign({}, r)));
          }
          loadedFromStorage = false;
        }
        // Removed per-site retention risk customization. All sites start with
        // the same retention risk defined in the seed rows.
        // Compute derived values
        rows.forEach((row, idx) => {
          row.id = idx;
          row.capabilityAvg = computeCapabilityAvg(row);
          row.capabilityBucket = bucketCapability(row.capabilityAvg);
          row.overallRisk = computeOverallRisk(row);
        });
      }

      // Load a given site, show the worksheet, and hide the start screen.
      function loadSite(siteName) {
        // Function implementation here
        // Always reset summary visibility when loading a new site.  Leaving
        // summaryVisible unchanged could cause the next site to open in
        // summary view when the user expects to start in the data view.
        summaryVisible = false;
        // Commit any in-progress edits before switching sites
        commitEditing();
        currentSite = siteName;
        siteParam = siteName;
        storageKey = storageBasePrefix + siteName;
        // Prepopulate the mill field
        const millInputEl2 = document.getElementById('inputMill');
        if (millInputEl2) {
          // Always set the mill input to the selected site
          millInputEl2.value = siteName;
        }
        // Load rows for this site
        loadRowsForSite();
        // Render the table view for the selected site
        renderTable();
        // Build navigation bar: always include Back to Start and links to other mills
        const navEl = document.querySelector('.site-nav');
        if (navEl) {
          // Build a minimal navigation bar for the single‚Äëplant view: just a back button.
          const navHtml = '<strong>Navigation:</strong> <button onclick="showStart()">Back to Start</button>';
          navEl.innerHTML = navHtml;
        }
        // Restore summary visibility if it was previously active. This ensures
        // that switching between sites retains the view state (summary vs data).
        const summaryEl = document.getElementById('summaryView');
        const dataEl = document.getElementById('dataView');
        const toggleBtn = document.getElementById('toggleSummary');
        if (summaryVisible) {
          generateSummary();
          summaryEl.classList.remove('hidden');
          dataEl.classList.add('hidden');
          if (toggleBtn) toggleBtn.textContent = 'Show Full Data';
        } else {
          summaryEl.classList.add('hidden');
          dataEl.classList.remove('hidden');
          if (toggleBtn) toggleBtn.textContent = 'Show Summary';
        }
        // Show site content and hide start view
        const siteDiv = document.getElementById('siteContent');
        const startDiv = document.getElementById('startView');
        if (siteDiv) siteDiv.style.display = '';
        if (startDiv) startDiv.style.display = 'none';
        // Reset the scroll position to the top whenever a new site is loaded.
        // Without this, the page may remain scrolled to the last position
        // when switching between mills, giving the impression that the
        // summary or some other section is being shown by default.
        window.scrollTo(0, 0);
      };

      /*
       * The showStart() function is defined globally earlier in the script.  A
       * duplicate implementation lived here inside the IIFE which could
       * override the global version and cause inconsistent behaviour.  It has
       * been removed so that the single global showStart() is used
       * everywhere.  See the global definition near the top of the script.
       */

      // On initial load, show the start screen.
      document.addEventListener('DOMContentLoaded', function() {
        showStart();
      });
      // In saved/offline versions the DOMContentLoaded event may have already fired
      // before this script executes.  If the document is already past the loading
      // stage, call showStart() immediately to ensure the start view is shown.
      if (document.readyState !== 'loading') {
        showStart();
      }

      /**
       * Reset the persisted data for all sites back to the original default
       * starting values. This function is called from a button on the
       * welcome page. It writes the default data back into localStorage
       * for Mosinee and Thilmany and clears any in-memory state. After
       * resetting, the next time a site is loaded it will read from the
       * freshly reset storage.
       */
      window.resetData = function() {
        try {
          // Persist deep copies of the default seeds into localStorage for all sites.
          // Use the configured storageBasePrefix rather than a hard‚Äëcoded prefix so that
          // resetting works correctly regardless of timestamp or mill context.
          siteNames.forEach(name => {
            try {
              const key = storageBasePrefix + name;
              const defaults = defaultData[name];
              if (defaults && Array.isArray(defaults)) {
                // Save a deep copy of the defaults to avoid mutating the originals later.
                localStorage.setItem(key, JSON.stringify(defaults.map(r => Object.assign({}, r))));
              } else {
                // If no defaults exist (should not happen), remove any stored data.
                localStorage.removeItem(key);
              }
            } catch (e2) {
              console.error('Failed to reset data for site', name, e2);
            }
          });
          // Clear in‚Äëmemory rows and site state. On next load the tool will
          // fetch the freshly reset defaults.
          rows = [];
          currentSite = null;
          siteParam = 'default';
          storageKey = storageBasePrefix + siteParam;
          alert('Data has been reset to the starting defaults for all mills.');
        } catch (e) {
          console.error('Failed to reset data:', e);
        }
      };

      // Save the current rows array to localStorage for this site. Invoked after
      // any edit so data persists between visits.
      function saveData() {
        try {
          localStorage.setItem(storageKey, JSON.stringify(rows));
        } catch (e) {
          // Silently ignore storage errors (e.g. quota exceeded)
        }
      }
      // Carry-forward for display: this returns array of displayRows with departmentDisplay and clusterDisplay plus rowspans
      function computeDisplayRows() {
        let displayRows = rows.map(row => Object.assign({}, row));
        // Carry-forward department & cluster display text
        let lastDept = null;
        let lastCluster = null;
        displayRows.forEach(r => {
          if (r.department) lastDept = r.department;
          r.departmentDisplay = r.department || lastDept || '';
          if (r.cluster) lastCluster = r.cluster;
          r.clusterDisplay = r.cluster || lastCluster || '';
        });
        // Compute grouping for rowspans
        // First group by departmentDisplay; then clusterDisplay
        let i = 0;
        while (i < displayRows.length) {
          const dept = displayRows[i].departmentDisplay;
          let j = i;
          // find consecutive rows with same department
          while (j < displayRows.length && displayRows[j].departmentDisplay === dept) {
            j++;
          }
          const deptCount = j - i;
          // inside this block, compute clusters
          let k = i;
          while (k < j) {
            const cluster = displayRows[k].clusterDisplay;
            let l = k;
            while (l < j && displayRows[l].clusterDisplay === cluster) {
              l++;
            }
            const clusterCount = l - k;
            // assign rowspans: if cluster text equals department text, merge cells (colspan=2) on first row
            for (let m = k; m < l; m++) {
              displayRows[m].deptRowspan = 0;
              displayRows[m].clusterRowspan = 0;
              displayRows[m].clusterMerged = false;
            }
            if (deptCount > 0) {
              // Only set deptRowspan on first cluster group start row
              displayRows[i].deptRowspan = deptCount;
            }
            if (clusterCount > 0) {
              // If department and cluster labels are identical (and non-empty) then merge into one cell with colspan=2
              if (cluster === dept && cluster) {
                // merge cluster into department: we'll mark clusterMerged on first row of this cluster
                displayRows[k].deptRowspan = clusterCount;
                displayRows[k].clusterMerged = true;
              } else {
                displayRows[k].clusterRowspan = clusterCount;
              }
            }
            k = l;
          }
          i = j;
        }
        return displayRows;
      }
      // Render full data table
      const tbody = document.querySelector('#dataTable tbody');
      function renderTable() {
        // Clear any active inline editor before rebuilding the table. After a
        // re-render, no cell should be marked as editing.
        editingCell = null;
        closePopover();
        tbody.innerHTML = '';
        // Utility to escape text for safe HTML insertion.  Converts &,<,> into
        // their HTML entities to prevent injection.  Only used within the
        // renderTable context.
        function escapeHtml(str) {
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        }

        // Build rows directly from the underlying data. Insert a department
        // section row whenever a new department value is encountered. The
        // section rows span all visible columns (8) and display the department
        // name.
        let prevDept = null;
        rows.forEach((r) => {
          // Insert a section header row if this row introduces a new department
          if (r.department && r.department !== prevDept) {
            const sectionTr = document.createElement('tr');
            sectionTr.className = 'dept-section';
            const td = document.createElement('td');
            td.colSpan = 8; // number of visible columns: role (includes cluster), crit, cap, ret, overall, comments, pref, gap
            td.textContent = r.department;
            sectionTr.appendChild(td);
            tbody.appendChild(sectionTr);
            prevDept = r.department;
          }
          const tr = document.createElement('tr');
          tr.dataset.rowId = r.id;
          // Role cell: include cluster name on top (small) followed by bold role name. Remove separate cluster column.
          const tdRole = document.createElement('td');
          tdRole.className = 'col-role';
          // Show only the role name in bold; cluster names have been removed
          // from the display per user feedback. Previously the cluster name was
          // rendered as a small label above the role. Now the role cell
          // contains only the bold role name to simplify the layout.
          const roleName = r.roleArea || '-';
          tdRole.innerHTML = `<strong>${roleName}</strong>`;
          // Attach a tooltip for the role if a definition exists.  This
          // provides additional context when hovering over the role name.
          const defn = roleDefinitions[roleName];
          if (defn) {
            tdRole.title = defn;
          }
          tr.appendChild(tdRole);
          // Criticality cell
          const tdCrit = document.createElement('td');
          tdCrit.className = 'col-crit';
          tdCrit.dataset.rowId = r.id;
          tdCrit.dataset.field = 'criticality';
          tdCrit.setAttribute('tabindex', 0);
          const critVal = r.criticality;
          tdCrit.textContent = critVal != null ? (critVal.toFixed(1)) : '-';
          // Round criticality to nearest integer for CSS class
          const critRounded = critVal != null ? Math.round(critVal) : null;
          const critClass = critRounded ? `crit-${critRounded}` : 'crit-null';
          tdCrit.classList.add(critClass);
          tr.appendChild(tdCrit);
          // Capability cell
          const tdCap = document.createElement('td');
          tdCap.className = 'col-cap';
          tdCap.dataset.rowId = r.id;
          tdCap.dataset.field = 'capability';
          tdCap.setAttribute('tabindex', 0);
          const avg = r.capabilityAvg;
          tdCap.textContent = avg != null ? avg.toFixed(1) : '-';
          const capBucket = bucketCapability(avg);
          if (capBucket) {
            tdCap.classList.add(`cap-${capBucket}`);
            const capBg = {1: '#f8d7da', 2: '#fff5d6', 3: '#d7e7d3'};
            const capFg = {1: '#842029', 2: '#8a6d00', 3: '#004400'};
            tdCap.style.backgroundColor = capBg[capBucket];
            tdCap.style.color = capFg[capBucket];
          }
          tr.appendChild(tdCap);
          // Retention risk cell
          const tdRet = document.createElement('td');
          tdRet.className = 'col-ret';
          tdRet.dataset.rowId = r.id;
          tdRet.dataset.field = 'retentionRisk';
          tdRet.setAttribute('tabindex', 0);
          const ret = r.retentionRisk || '-';
          tdRet.textContent = ret;
          const retClass = (ret && ret !== '-') ? `ret-${ret}` : 'ret-null';
          tdRet.classList.add(retClass);
          tr.appendChild(tdRet);
          // Overall risk cell
          const tdOverall = document.createElement('td');
          tdOverall.className = 'col-overall';
          const overall = r.overallRisk;
          tdOverall.textContent = overall || '-';
          if (overall) tdOverall.classList.add(`overall-${overall}`);
          tr.appendChild(tdOverall);
          // Comments cell
          const tdComments = document.createElement('td');
          tdComments.className = 'col-comments';
          tdComments.dataset.rowId = r.id;
          tdComments.dataset.field = 'comments';
          tdComments.setAttribute('tabindex', 0);
          // Build separate sections for capability and retention comments.  Each
          // section is wrapped in its own <div> to align on separate rows
          // within the cell.  This prevents the two comment types from
          // merging together when consolidating data and improves
          // readability.  We also preserve any additional comments as a
          // third section if provided.  Bulleted lists are created for
          // each set of comments.
          const capLines = [];
          if (r.capabilityComment) {
            r.capabilityComment.split(/\n/).forEach(l => {
              const trimmed = l.trim();
                if (trimmed) {
                  // Push comment line after escaping HTML characters to prevent XSS
                  capLines.push(escapeHtml(trimmed));
                }
            });
          }
          // Do not insert placeholder bullets for capability when there are no
          // notes.  Leaving the section empty avoids unwanted characters
          // being included in consolidated comments.
          // (capLines remains empty if there are no capability comments)
          const retLines = [];
          if (r.retentionComment) {
              r.retentionComment.split(/\n/).forEach(l => {
                const trimmed = l.trim();
                if (trimmed) {
                  retLines.push(escapeHtml(trimmed));
                }
              });
          }
          const addLines = [];
          if (r.comments) {
              r.comments.split(/\n/).forEach(l => {
                const trimmed = l.trim();
                if (trimmed) {
                  addLines.push(escapeHtml(trimmed));
                }
              });
          }
          // Build DOM for each section instead of using innerHTML.  Setting
          // textContent on each element avoids HTML injection and ensures
          // user-entered characters like < and > are displayed safely.
          tdComments.innerHTML = '';
          // Capability section
          {
            const div = document.createElement('div');
            const strong = document.createElement('strong');
            strong.textContent = 'Capability:';
            div.appendChild(strong);
            div.appendChild(document.createElement('br'));
            capLines.forEach((line, idx) => {
              const span = document.createElement('span');
              span.textContent = line;
              div.appendChild(span);
              if (idx < capLines.length - 1) div.appendChild(document.createElement('br'));
            });
            tdComments.appendChild(div);
          }
          // Retention section
          {
            const div = document.createElement('div');
            div.style.marginTop = '4px';
            const strong = document.createElement('strong');
            strong.textContent = 'Retention:';
            div.appendChild(strong);
            div.appendChild(document.createElement('br'));
            retLines.forEach((line, idx) => {
              const span = document.createElement('span');
              span.textContent = line;
              div.appendChild(span);
              if (idx < retLines.length - 1) div.appendChild(document.createElement('br'));
            });
            tdComments.appendChild(div);
          }
          // Additional comments section (if any)
          if (addLines.length) {
            const div = document.createElement('div');
            div.style.marginTop = '4px';
            const strong = document.createElement('strong');
            strong.textContent = 'Additional:';
            div.appendChild(strong);
            div.appendChild(document.createElement('br'));
            addLines.forEach((line, idx) => {
              const span = document.createElement('span');
              span.textContent = line;
              div.appendChild(span);
              if (idx < addLines.length - 1) div.appendChild(document.createElement('br'));
            });
            tdComments.appendChild(div);
          }
          // Append comments cell to the row.  We do not bind a direct click
          // handler here; event delegation on the table body handles
          // editing.
          tr.appendChild(tdComments);
          // Preferred Method cell
          const tdPref = document.createElement('td');
          tdPref.className = 'col-pref';
          tdPref.dataset.rowId = r.id;
          tdPref.dataset.field = 'preferredMethod';
          tdPref.setAttribute('tabindex', 0);
          tdPref.textContent = r.preferredMethod || '-';
          tr.appendChild(tdPref);
          // Gap Method Comment cell
          const tdGap = document.createElement('td');
          tdGap.className = 'col-gap';
          tdGap.dataset.rowId = r.id;
          tdGap.dataset.field = 'gapMethodComment';
          tdGap.setAttribute('tabindex', 0);
          tdGap.textContent = r.gapMethodComment || '';
          tr.appendChild(tdGap);
          tbody.appendChild(tr);
        });
        // After building the table rows, apply all colors comprehensively
        // to ensure they never appear white or mismatched.
        reapplyAllColors();
      }

    /**
     * Iterate over all capability cells in the current table and apply the
     * appropriate RAG colour classes and inline styles based solely on the
     * displayed numeric value. This is used as a final pass after rendering
     * the table to guard against missed updates and ensure colours never
     * remain white or mismatched. The function parses the cell text, uses
     * bucketCapability to determine whether the value is low (1), medium (2)
     * or high (3), then assigns the cap-* class and inline colours.
     */
    function reapplyCapabilityColours() {
      const capCells = tbody.querySelectorAll('td.col-cap');
      capCells.forEach(cell => {
        const text = cell.textContent.trim();
        const num = parseFloat(text);
        if (!isNaN(num)) {
          const bucket = bucketCapability(num);
          if (bucket) {
            // Remove any existing capability classes
            cell.classList.remove('cap-1', 'cap-2', 'cap-3');
            cell.classList.add(`cap-${bucket}`);
            // Inline colours to override row striping
            const capBg = {1: '#f8d7da', 2: '#fff5d6', 3: '#d7e7d3'};
            const capFg = {1: '#842029', 2: '#8a6d00', 3: '#004400'};
            cell.style.backgroundColor = capBg[bucket];
            cell.style.color = capFg[bucket];
          }
        }
      });
    }
    
    /**
     * Comprehensive function to reapply all color coding to all cell types.
     * This ensures proper coloring after consolidation or any data updates.
     * It handles criticality, capability, retention risk, and overall risk cells.
     */
    function reapplyAllColors() {
      // Reapply criticality colors
      const critCells = tbody.querySelectorAll('td.col-crit');
      critCells.forEach(cell => {
        const text = cell.textContent.trim();
        const num = parseFloat(text);
        
        // Remove all existing criticality classes
        cell.classList.remove('crit-1', 'crit-2', 'crit-3', 'crit-null');
        
        if (!isNaN(num)) {
          const rounded = Math.round(num);
          cell.classList.add(`crit-${rounded}`);
          // Apply inline styles to ensure colors show
          const critBg = {1: '#d7e7d3', 2: '#fff5d6', 3: '#f8d7da'};
          const critFg = {1: '#004400', 2: '#8a6d00', 3: '#842029'};
          if (critBg[rounded]) {
            cell.style.backgroundColor = critBg[rounded] + ' !important';
            cell.style.color = critFg[rounded] + ' !important';
          }
        } else {
          cell.classList.add('crit-null');
        }
      });
      
      // Reapply capability colors (use existing function)
      reapplyCapabilityColours();
      
      // Reapply retention risk colors
      const retCells = tbody.querySelectorAll('td.col-ret');
      retCells.forEach(cell => {
        const text = cell.textContent.trim();
        
        // Remove all existing retention classes
        cell.classList.remove('ret-L', 'ret-M', 'ret-H', 'ret-null');
        
        if (text === 'L' || text === 'M' || text === 'H') {
          cell.classList.add(`ret-${text}`);
          // Apply inline styles to ensure colors show
          const retBg = {L: '#d7e7d3', M: '#fff5d6', H: '#f8d7da'};
          const retFg = {L: '#004400', M: '#8a6d00', H: '#842029'};
          if (retBg[text]) {
            cell.style.backgroundColor = retBg[text] + ' !important';
            cell.style.color = retFg[text] + ' !important';
          }
        } else {
          cell.classList.add('ret-null');
        }
      });
      
      // Reapply overall risk colors
      const overallCells = tbody.querySelectorAll('td.col-overall');
      overallCells.forEach(cell => {
        const text = cell.textContent.trim();
        
        // Remove all existing overall risk classes
        cell.classList.remove('overall-Low', 'overall-Medium', 'overall-High', 'overall-Critical');
        
        if (text === 'Low' || text === 'Medium' || text === 'High' || text === 'Critical') {
          cell.classList.add(`overall-${text}`);
          // Apply inline styles to ensure colors show
          const overallBg = {
            Low: '#d7e7d3',
            Medium: '#fff5d6', 
            High: '#f8d7da',
            Critical: '#e5b7b9'
          };
          const overallFg = {
            Low: '#004400',
            Medium: '#8a6d00',
            High: '#842029',
            Critical: '#660000'
          };
          if (overallBg[text]) {
            cell.style.backgroundColor = overallBg[text] + ' !important';
            cell.style.color = overallFg[text] + ' !important';
            if (text === 'Critical') {
              // Add animation for critical
              cell.style.animation = 'pulse 2s infinite !important';
            }
          }
        }
      });
    }
      // Render initial table
      renderTable();
      // Editing interactions - these are already declared globally
      function closePopover() {
        if (currentPopover) {
          document.body.removeChild(currentPopover);
          currentPopover = null;
        }
      }
      document.addEventListener('click', (evt) => {
        const target = evt.target;
        // If a capability popover is open and the click occurred outside of it and not on another capability cell,
        // commit any outstanding edits and close the popover. We retrieve the associated row ID from the popover's
        // dataset so we can recompute derived fields and persist changes. After committing we reset editingCell.
        if (currentPopover && !currentPopover.contains(target) && !target.closest('.col-cap')) {
          // Commit changes if possible
          const rowId = currentPopover.dataset.rowId;
          if (rowId !== undefined) {
            const idNum = parseInt(rowId);
            if (!isNaN(idNum)) {
              updateRow(idNum);
            }
          }
          editingCell = null;
          closePopover();
        }
      });
      document.addEventListener('keydown', (evt) => {
        if (evt.key === 'Escape' && currentPopover) {
          closePopover();
        }
      });
      // Helper to update row and re-render row only
      function updateRow(id) {
        const row = rows[id];
        row.capabilityAvg = computeCapabilityAvg(row);
        row.capabilityBucket = bucketCapability(row.capabilityAvg);
        row.overallRisk = computeOverallRisk(row);
        // Persist data to storage for this site
        saveData();
        // Re-render entire table (simpler) for now
        renderTable();
        // Force reapply all colors after a short delay to ensure DOM is updated
        setTimeout(() => {
          reapplyAllColors();
        }, 50);
      }

      /**
       * Commit any in-progress inline edits by blurring the active editor. When
       * a select or textarea is open, calling blur() will trigger its
       * respective blur handler which calls updateRow() and saveData(). This
       * function should be called before switching sites or returning to
       * the start screen to ensure no data is lost.
       */
      function commitEditing() {
        if (editingCell) {
          const input = editingCell.querySelector('input, select, textarea');
          if (input) {
            input.blur();
          }
        }
      }
      // Event delegation for cell clicks
      tbody.addEventListener('click', function(evt) {
        /**
         * Normalize the click target to the containing TD element. Sometimes
         * users may click on text nodes or child elements; walk up the DOM
         * until we hit a TD or abort if not found.
         */
        let el = evt.target;
        while (el && el.tagName !== 'TD') {
          el = el.parentElement;
        }
        const cell = el;
        if (!cell) return;
        // If a select or textarea is already open for editing, avoid
        // reentering edit mode. Allow clicks inside the currently
        // editing cell (e.g. to open dropdown) to be handled by the
        // control itself but prevent creating another editor on blur.
        if (editingCell) {
          // If click is inside the active editing cell, do nothing here.
          if (editingCell.contains(evt.target)) {
            return;
          }
        }
        // If a popover (for capability editing) is open, do not open a new editor
        if (currentPopover) {
          return;
        }

        // Determine row id either from cell or fallback to its parent TR
        let rowId = parseInt(cell.dataset.rowId);
        if (isNaN(rowId)) {
          const trEl = cell.closest('tr');
          if (trEl && trEl.dataset && trEl.dataset.rowId) {
            rowId = parseInt(trEl.dataset.rowId);
          }
        }
        // Determine which editor to invoke based on CSS class rather than
        // relying solely on data-field attributes. This guards against cases
        // where dataset may be missing due to DOM quirks (e.g. merged cells).
        if (cell.classList.contains('col-comments')) {
          editComments(cell, rowId);
          return;
        }
        if (cell.classList.contains('col-crit')) {
          editCriticality(cell, rowId);
          return;
        }
        if (cell.classList.contains('col-ret')) {
          editRetention(cell, rowId);
          return;
        }
        if (cell.classList.contains('col-pref')) {
          editPreferredMethod(cell, rowId);
          return;
        }
        if (cell.classList.contains('col-gap')) {
          editGapComment(cell, rowId);
          return;
        }
        if (cell.classList.contains('col-cap')) {
          editCapabilityDimensions(cell, rowId);
          return;
        }
      });
      // Editing functions
      function editCriticality(cell, id) {
        // Prevent multiple editors: if this cell is already being edited, ignore
        if (editingCell) return;
        const row = rows[id];
        const select = document.createElement('select');
        [1,2,3].forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val.toFixed(1);
          if (row.criticality === val) opt.selected = true;
          select.appendChild(opt);
        });
        select.style.width = '100%';
        cell.innerHTML = '';
        cell.appendChild(select);
        select.focus();
        // Immediately update and save when the user selects a new value. This
        // commits the change without requiring the user to click away. After
        // updating, reset editingCell to allow new edits.
        select.addEventListener('change', () => {
          row.criticality = parseInt(select.value);
          updateRow(id);
          editingCell = null;
        });
        // Preserve a blur handler to clean up if the user clicks away without
        // changing the value. It won't save again because updateRow was
        // already invoked on change.
        select.addEventListener('blur', () => {
          if (editingCell) {
            updateRow(id);
            editingCell = null;
          }
        });
        // Mark this cell as currently being edited
        editingCell = cell;
      }
      function editRetention(cell, id) {
        // Inline editor for retention risk: similar behaviour to criticality and preferred
        // Avoid opening multiple editors at once
        if (editingCell) return;
        const row = rows[id];
        const select = document.createElement('select');
        ['-','L','M','H'].forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          if ((row.retentionRisk || '-') === val) opt.selected = true;
          select.appendChild(opt);
        });
        select.style.width = '100%';
        cell.innerHTML = '';
        cell.appendChild(select);
        select.focus();
        // Immediately update and save when a new retention risk is chosen
        select.addEventListener('change', () => {
          const val = select.value;
          row.retentionRisk = (val === '-') ? '-' : val;
          updateRow(id);
          editingCell = null;
        });
        // Blur handler only commits if still editing (no change occurred)
        select.addEventListener('blur', () => {
          if (editingCell) {
            updateRow(id);
            editingCell = null;
          }
        });
        editingCell = cell;
      }
      function editPreferredMethod(cell, id) {
        // Prevent multiple editors
        if (editingCell) return;
        const row = rows[id];
        const select = document.createElement('select');
        // Use Title-case values for preferred method to match seed data.  Lowercase
        // internal values caused inconsistent casing in the UI and exported data.
        ['-','Build','Buy','Borrow','Bot','Retain'].forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          // Select the option if it matches the current value (case-insensitive).
          if ((row.preferredMethod || '-').toLowerCase() === val.toLowerCase()) opt.selected = true;
          select.appendChild(opt);
        });
        // Remove any duplicate entries that may have been added inadvertently by the browser.
        {
          const seen = new Set();
          const toRemove = [];
          Array.from(select.options).forEach(opt => {
            if (seen.has(opt.value)) {
              toRemove.push(opt);
            } else {
              seen.add(opt.value);
            }
          });
          toRemove.forEach(opt => opt.remove());
        }
        select.style.width = '100%';
        cell.innerHTML = '';
        cell.appendChild(select);
        select.focus();
        // Immediately update and save when the user selects a preferred method
        select.addEventListener('change', () => {
          // Store the preferred method in Title-case.  The '-' option is kept as is.
          row.preferredMethod = select.value === '-' ? '-' : select.value;
          updateRow(id);
          editingCell = null;
        });
        // Blur handler ensures a commit if no change occurred before leaving
        select.addEventListener('blur', () => {
          if (editingCell) {
            updateRow(id);
            editingCell = null;
          }
        });
        editingCell = cell;
      }
      function editComments(cell, id) {
        // Inline editing of comments using two separate textareas: one for
        // capability comments and one for retention comments.  Changes are
        // automatically committed when the user clicks away from the
        // editing container.  This eliminates the need for explicit
        // Save/Cancel buttons and still allows the user to edit both
        // comment types within a single interaction.
        if (editingCell) return;
        const row = rows[id];
        // Close any existing popover when editing comments
        closePopover();
        // Build the editing UI
        cell.innerHTML = '';
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.gap = '4px';
        // Capability label and textarea
        const capLabel = document.createElement('label');
        capLabel.textContent = 'Capability:';
        const capTextarea = document.createElement('textarea');
        capTextarea.style.width = '100%';
        capTextarea.style.minHeight = '60px';
        capTextarea.value = row.capabilityComment || '';
        // Retention label and textarea
        const retLabel = document.createElement('label');
        retLabel.textContent = 'Retention:';
        const retTextarea = document.createElement('textarea');
        retTextarea.style.width = '100%';
        retTextarea.style.minHeight = '60px';
        retTextarea.value = row.retentionComment || '';
        // When focus leaves the editing container, automatically commit
        // any changes entered by the user.  This replaces explicit Save/Cancel
        // buttons.  We listen for focusout events and check if the new
        // focused element is outside of the editing container.  If it is,
        // we update the underlying data and re-render the row.
        container.addEventListener('focusout', (evt) => {
          // relatedTarget may be null if focus leaves the document
          const newTarget = evt.relatedTarget;
          if (!container.contains(newTarget)) {
            // Commit changes
            row.capabilityComment = capTextarea.value.trim();
            row.retentionComment = retTextarea.value.trim();
            updateRow(id);
            editingCell = null;
          }
        });
        // Assemble the UI
        container.appendChild(capLabel);
        container.appendChild(capTextarea);
        container.appendChild(retLabel);
        container.appendChild(retTextarea);
        cell.appendChild(container);
        editingCell = cell;
      }
      function editGapComment(cell, id) {
        // Inline editing of gap comment. Ensure only one editor is open at a time.
        if (editingCell) return;
        const row = rows[id];
        const textarea = document.createElement('textarea');
        textarea.style.width = '100%';
        textarea.style.minHeight = '60px';
        textarea.value = row.gapMethodComment || '';
        cell.innerHTML = '';
        cell.appendChild(textarea);
        textarea.focus();
        textarea.addEventListener('blur', () => {
          row.gapMethodComment = textarea.value.trim();
          updateRow(id);
          editingCell = null;
        });
        editingCell = cell;
      }
      function editCapabilityDimensions(cell, id) {
        // open a popover near cell with five dropdowns
        closePopover();
        const row = rows[id];
        const rect = cell.getBoundingClientRect();
        const pop = document.createElement('div');
        pop.className = 'popover';
        // Use fixed positioning so the popover is placed relative to the viewport
        pop.style.position = 'fixed';
        // Build controls
        const dims = [
          { key: 'capTech', label: 'Technical knowledge' },
          { key: 'capExperience', label: 'Experience' },
          { key: 'capCrisis', label: 'Crisis management' },
          { key: 'capLeadComm', label: 'Leadership & Communication' },
          { key: 'capSafety', label: 'Safety mindset' }
        ];
        // Mark this cell as being edited so commitEditing() can attempt to
        // finish any in-progress editing when switching pages. Although
        // capability editing uses a popover with separate selects, we still
        // assign editingCell to the capability cell so commitEditing() will
        // attempt to blur it when navigating away. This helps ensure that any
        // unsaved changes are committed before leaving the page.
        editingCell = cell;

        dims.forEach(dim => {
          const label = document.createElement('label');
          label.textContent = dim.label;
          const select = document.createElement('select');
          ['','1','2','3'].forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v || '-';
            const current = row[dim.key];
            if (v === '' && (current === null || current === undefined)) opt.selected = true;
            if (v && parseInt(v) === current) opt.selected = true;
            select.appendChild(opt);
          });
          // Persist capability changes immediately. When a user selects a new
          // value we update the underlying row property, recompute derived
          // fields and save to localStorage via updateRow(). This ensures that
          // switching sites or returning to the start page will not discard
          // capability edits.
          select.addEventListener('change', () => {
            const val = select.value;
            // Update the underlying capability dimension on this row.  Do not
            // immediately close the popover or re-render the table; instead
            // compute the derived fields and persist the data silently.  The
            // table will refresh when the user clicks outside the popover,
            // which triggers the global click handler to commit changes.
            row[dim.key] = val ? parseInt(val) : null;
            // Recompute capability average, bucket and overall risk on the fly.
            row.capabilityAvg = computeCapabilityAvg(row);
            row.capabilityBucket = bucketCapability(row.capabilityAvg);
            row.overallRisk = computeOverallRisk(row);
            // Persist but do not re-render.
            saveData();
          });
          label.appendChild(select);
          pop.appendChild(label);
        });
        // Assign the row ID to the popover so we know which row to commit when closing
        document.body.appendChild(pop);
        pop.dataset.rowId = id;
        /*
         * After appending the popover to the body, measure its dimensions and
         * position it within the viewport. We compute a tentative top/left
         * relative to the clicked cell (below the cell by default) and then
         * adjust to ensure the entire popover remains visible. Without this,
         * the popover could extend beyond the viewport, making part of it
         * unreachable on smaller screens or when the table is scrolled toward
         * the bottom.
         */
        const popRect = pop.getBoundingClientRect();
        // Default placement: below the cell
        let top = rect.bottom;
        let left = rect.left;
        // If the popover would overflow the bottom of the viewport, place it above
        if (top + popRect.height > window.innerHeight) {
          top = rect.top - popRect.height;
        }
        // Clamp vertical position within viewport
        if (top < 0) top = 0;
        if (top + popRect.height > window.innerHeight) {
          top = window.innerHeight - popRect.height;
        }
        // Clamp horizontal position within viewport
        if (left + popRect.width > window.innerWidth) {
          left = window.innerWidth - popRect.width;
        }
        if (left < 0) left = 0;
        pop.style.top = `${top}px`;
        pop.style.left = `${left}px`;
        // Record this popover so it can be closed later
        currentPopover = pop;
        pop.tabIndex = -1;
        pop.focus();
      }
      // Summary view generation
      function generateSummary() {
        const container = document.getElementById('summaryView');
        container.innerHTML = '';
        /**
         * This function builds an interactive summary view containing:
         * 1. A critical spotlight table for roles with High or Critical overall risk.
         * 2. A scatter chart of Capability vs. Criticality.
         * 3. A scatter chart of Retention Risk vs. Criticality.
         * 4. A bar chart showing the distribution of overall risk categories.
         * 5. A cross‚Äëtable linking overall risk to preferred method counts.
         * 6. A word summary listing role areas grouped by overall risk.
         */
        // Helper to build a card
        function createCard(titleText) {
          const card = document.createElement('div');
          card.className = 'summary-card';
          const title = document.createElement('h2');
          title.textContent = titleText;
          card.appendChild(title);
          return card;
        }
        // Critical spotlight (full listing). Show all roles (13) sorted by overall risk
        // severity: Critical first, then High, Medium, Low, and unset last. Remove
        // the department and cluster columns to focus on the role and risk values.
        {
          // Create a sorted copy of rows
          const sorted = rows.slice().sort((a, b) => {
            const order = {Critical:0, High:1, Medium:2, Low:3, '-':4, undefined:4};
            const aKey = a.overallRisk || '-';
            const bKey = b.overallRisk || '-';
            return order[aKey] - order[bKey];
          });
          const card = createCard('As-Is Summary');
          // Mark this card as the As‚ÄëIs summary so the CSS sizing rules apply
          card.classList.add('as-is');
          const table = document.createElement('table');
          const thead = document.createElement('thead');
          // Only include columns for Role Area and risk-related fields
          // Reorder columns so Criticality appears before Capability (avg) per user request
          thead.innerHTML = '<tr><th>Role Area</th><th>Criticality</th><th>Capability (avg)</th><th>Retention Risk</th><th>Overall Risk</th></tr>';
          table.appendChild(thead);
          const tbodyEl = document.createElement('tbody');
          sorted.forEach(r => {
            const tr = document.createElement('tr');
            // Role area
            const tdRole = document.createElement('td');
            tdRole.textContent = r.roleArea || '-';
            tr.appendChild(tdRole);
            // Criticality (before capability)
            const tdCrit = document.createElement('td');
            if (r.criticality != null) {
              tdCrit.textContent = r.criticality.toFixed(1);
              tdCrit.classList.add(`crit-${Math.round(r.criticality)}`);
            } else {
              tdCrit.textContent = '-';
              tdCrit.classList.add('crit-null');
            }
            tr.appendChild(tdCrit);
            // Capability average with RAG styling
            const tdCap = document.createElement('td');
            tdCap.textContent = r.capabilityAvg != null ? r.capabilityAvg.toFixed(1) : '-';
            const capBucket = bucketCapability(r.capabilityAvg);
            if (capBucket) {
              tdCap.classList.add(`cap-${capBucket}`);
              const capBg = {1: '#f8d7da', 2: '#fff5d6', 3: '#d7e7d3'};
              const capFg = {1: '#842029', 2: '#8a6d00', 3: '#004400'};
              tdCap.style.backgroundColor = capBg[capBucket];
              tdCap.style.color = capFg[capBucket];
            }
            tr.appendChild(tdCap);
            // Retention risk
            const tdRet = document.createElement('td');
            const retVal = r.retentionRisk || '-';
            tdRet.textContent = retVal;
            const retClass = (retVal && retVal !== '-') ? `ret-${retVal}` : 'ret-null';
            tdRet.classList.add(retClass);
            tr.appendChild(tdRet);
            // Overall risk
            const tdOverall = document.createElement('td');
            const risk = r.overallRisk || '-';
            tdOverall.textContent = risk;
            if (risk && risk !== '-') {
              tdOverall.classList.add(`overall-${risk}`);
            }
            tr.appendChild(tdOverall);
            tbodyEl.appendChild(tr);
          });
          table.appendChild(tbodyEl);
          card.appendChild(table);
          container.appendChild(card);

        // Capability As‚ÄëIs table moved here for better grouping. This
        // simplified heatmap lists only the capability dimensions and
        // overall capability rating. It appears immediately after the
        // As‚ÄëIs summary.
        {
          const capCard = createCard('Capability As-Is');
          capCard.classList.add('cap-heatmap');
          const capTable = document.createElement('table');
          const capThead = document.createElement('thead');
          capThead.innerHTML = '<tr>' +
            '<th>Role Area</th>' +
            '<th>Technical knowledge</th>' +
            '<th>Experience</th>' +
            '<th>Crisis management</th>' +
            '<th>Leadership &amp; Communication</th>' +
            '<th>Safety mindset</th>' +
            '<th>Overall capability rating</th>' +
            '</tr>';
          capTable.appendChild(capThead);
          const capTbody = document.createElement('tbody');
          rows.forEach(r => {
            const tr2 = document.createElement('tr');
            const tdRole2 = document.createElement('td');
            tdRole2.textContent = r.roleArea || '-';
            tr2.appendChild(tdRole2);
            function appendCapCell2(value) {
              const td = document.createElement('td');
              if (value != null && value !== '') {
                const num = Number(value);
                if (!isNaN(num)) {
                  td.textContent = num.toFixed(1);
                  const bucket = bucketCapability(num);
                  if (bucket) {
                    td.classList.add(`cap-${bucket}`);
                  }
                } else {
                  td.textContent = value;
                }
              } else {
                td.textContent = '-';
              }
              return td;
            }
            tr2.appendChild(appendCapCell2(r.capTech));
            tr2.appendChild(appendCapCell2(r.capExperience));
            tr2.appendChild(appendCapCell2(r.capCrisis));
            tr2.appendChild(appendCapCell2(r.capLeadComm));
            tr2.appendChild(appendCapCell2(r.capSafety));
            // Overall capability rating
            const tdCapAvg2 = document.createElement('td');
            if (r.capabilityAvg != null) {
              tdCapAvg2.textContent = r.capabilityAvg.toFixed(1);
              const bucket = bucketCapability(r.capabilityAvg);
              if (bucket) tdCapAvg2.classList.add(`cap-${bucket}`);
            } else {
              tdCapAvg2.textContent = '-';
            }
            tr2.appendChild(tdCapAvg2);
            capTbody.appendChild(tr2);
          });
          capTable.appendChild(capTbody);
          capCard.appendChild(capTable);
          container.appendChild(capCard);
        }
        }
        // Prepare data arrays for tables and quadrants
        const riskCounts = {Low:0, Medium:0, High:0, Critical:0};
        const riskMethodCounts = {};
        // Quadrant containers
        const capCritQuads = {
          HH: [], // High capability, High criticality
          HL: [], // High capability, Low criticality
          LH: [], // Low capability, High criticality
          LL: []  // Low capability, Low criticality
        };
        const retCritQuads = {
          HH: [], // High retention risk, High criticality
          HL: [], // High retention risk, Low criticality
          LH: [], // Low retention risk, High criticality
          LL: []  // Low retention risk, Low criticality
        };
        rows.forEach(r => {
          // Overall risk distribution
          if (r.overallRisk) {
            riskCounts[r.overallRisk] = (riskCounts[r.overallRisk] || 0) + 1;
          }
          // Risk vs preferred method cross table
          const risk = r.overallRisk || '-';
          // Normalise the preferred method to Title-case for grouping.  Without this,
          // lower-case or mixed-case values create duplicate columns in the cross
          // table.  A leading dash is preserved as-is for unset values.
          let method = r.preferredMethod || '-';
          if (method !== '-') {
            method = method.charAt(0).toUpperCase() + method.slice(1).toLowerCase();
          }
          if (!riskMethodCounts[risk]) riskMethodCounts[risk] = {};
          riskMethodCounts[risk][method] = (riskMethodCounts[risk][method] || 0) + 1;
          // Compute high/low for capability and criticality
          const capHigh = (r.capabilityAvg != null && r.capabilityAvg >= 2);
          const critHigh = (r.criticality != null && r.criticality >= 2);
          const capCritKey = (capHigh ? 'H' : 'L') + (critHigh ? 'H' : 'L');
          capCritQuads[capCritKey].push(r.roleArea);
          // Compute high/low for retention risk (H and M considered high)
          const retNum = mapRetentionNum(r.retentionRisk);
          const retHigh = (retNum != null && retNum >= 2);
          const retCritKey = (retHigh ? 'H' : 'L') + (critHigh ? 'H' : 'L');
          retCritQuads[retCritKey].push(r.roleArea);
        });
        // Quadrant: Capability vs Criticality
        {
          const card = createCard('Capability vs Criticality (Quadrants)');
          const quadWrap = document.createElement('div');
          quadWrap.style.display = 'flex';
          quadWrap.style.flexWrap = 'wrap';
          const quadDefs = [
            // High criticality quadrants first: high capability/high crit and low capability/high crit
            { key:'HH', title:'High Capability & High Criticality' },
            { key:'LH', title:'Low Capability & High Criticality' },
            // Then low criticality quadrants: high capability/low crit and low capability/low crit
            { key:'HL', title:'High Capability & Low Criticality' },
            { key:'LL', title:'Low Capability & Low Criticality' }
          ];
          quadDefs.forEach(def => {
            const box = document.createElement('div');
            box.style.flex = '1 0 45%';
            box.style.border = '1px solid #ddd';
            box.style.margin = '4px';
            box.style.padding = '4px';
            // Apply RAG colour coding to capability vs criticality quadrants.
            // High capability & high/low criticality are green; low capability & high criticality is red; low capability & low criticality is amber.
            const capCritColors = { HH: '#d7e7d3', HL: '#d7e7d3', LH: '#f8d7da', LL: '#fff5d6' };
            const capCritText = { HH: '#004400', HL: '#004400', LH: '#842029', LL: '#8a6d00' };
            const bgCol = capCritColors[def.key] || '#fff';
            const fgCol = capCritText[def.key] || '#333';
            box.style.backgroundColor = bgCol;
            box.style.color = fgCol;
            const heading = document.createElement('strong');
            heading.textContent = def.title;
            box.appendChild(heading);
            const roles = capCritQuads[def.key] || [];
            if (roles.length) {
              const ul = document.createElement('ul');
              roles.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                ul.appendChild(li);
              });
              box.appendChild(ul);
            } else {
              const span = document.createElement('span');
              span.textContent = ' none';
              box.appendChild(span);
            }
            quadWrap.appendChild(box);
          });
          card.appendChild(quadWrap);
          container.appendChild(card);
        }
        // Quadrant: Retention Risk vs Criticality
        {
          const card = createCard('Retention Risk vs Criticality (Quadrants)');
          const quadWrap = document.createElement('div');
          quadWrap.style.display = 'flex';
          quadWrap.style.flexWrap = 'wrap';
          const quadDefs = [
            // High criticality quadrants first (high retention/high criticality and low retention/high criticality)
            { key:'HH', title:'High Retention Risk & High Criticality' },
            { key:'LH', title:'Low Retention Risk & High Criticality' },
            // Then low criticality quadrants
            { key:'HL', title:'High Retention Risk & Low Criticality' },
            { key:'LL', title:'Low Retention Risk & Low Criticality' }
          ];
          quadDefs.forEach(def => {
            const box = document.createElement('div');
            // The quadrant boxes share styling with the capability vs criticality
            // quadrants; each box is roughly half width, with padding and a border.
            box.style.flex = '1 0 45%';
            box.style.border = '1px solid #ddd';
            box.style.margin = '4px';
            box.style.padding = '4px';
            /*
             * Apply RAG colour coding based on the combination of retention risk
             * (high/low) and criticality (high/low). High retention risk and
             * high criticality represent the highest concern and are coloured
             * red. High retention with low criticality is amber, while low
             * retention with high criticality is amber as well. Low retention
             * combined with low criticality is green. These colours align
             * with the main RAG scheme used throughout the assessment.
             */
            const retCritColors = { HH: '#f8d7da', HL: '#fff5d6', LH: '#fff5d6', LL: '#d7e7d3' };
            const retCritText = { HH: '#842029', HL: '#8a6d00', LH: '#8a6d00', LL: '#004400' };
            const bgCol = retCritColors[def.key] || '#fff';
            const fgCol = retCritText[def.key] || '#333';
            box.style.backgroundColor = bgCol;
            box.style.color = fgCol;
            const heading = document.createElement('strong');
            heading.textContent = def.title;
            box.appendChild(heading);
            const roles = retCritQuads[def.key] || [];
            if (roles.length) {
              const ul = document.createElement('ul');
              roles.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                ul.appendChild(li);
              });
              box.appendChild(ul);
            } else {
              const span = document.createElement('span');
              span.textContent = ' none';
              box.appendChild(span);
            }
            quadWrap.appendChild(box);
          });
          card.appendChild(quadWrap);
          container.appendChild(card);
        }
        // Bar chart: Overall risk distribution
        {
          const card = createCard('Overall Risk Distribution');
          const canvas = document.createElement('canvas');
          canvas.width = 400;
          canvas.height = 260;
          card.appendChild(canvas);
          drawBar(canvas, riskCounts);
          container.appendChild(card);
        }
        // Risk vs Preferred Method cross table removed as per requirements.

        // Roles by risk level summary
        {
          const card = createCard('Roles by Risk Level');
          const listContainer = document.createElement('div');
          ['Critical','High','Medium','Low','-'].forEach(level => {
            const roles = rows.filter(r => (r.overallRisk || '-') === level);
            const section = document.createElement('div');
            const heading = document.createElement('strong');
            heading.textContent = (level === '-' ? 'Unset' : level) + ':';
            section.appendChild(heading);
            if (roles.length) {
              const ul = document.createElement('ul');
              roles.forEach(r => {
                const li = document.createElement('li');
                // Determine preferred method text
                const methodText = r.preferredMethod && r.preferredMethod !== '-' ? r.preferredMethod : 'Unset';
                // Build display string: role name followed by arrow and preferred method
                li.textContent = `${r.roleArea} -> ${methodText}`;
                ul.appendChild(li);
              });
              section.appendChild(ul);
            } else {
              const span = document.createElement('span');
              span.textContent = ' none';
              section.appendChild(span);
            }
            listContainer.appendChild(section);
          });
          card.appendChild(listContainer);
          container.appendChild(card);
        }
      }

      /**
       * Draw a simple scatter chart on the provided canvas.
       * data: array of {x, y, label}. options: {xLabel, yLabel, xMin, xMax, yMin, yMax}
       */
      function drawScatter(canvas, data, options) {
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        // Margins
        const marginLeft = 40;
        const marginBottom = 30;
        const marginTop = 20;
        const marginRight = 20;
        ctx.clearRect(0,0,w,h);
        ctx.font = '10px sans-serif';
        ctx.fillStyle = '#333';
        ctx.strokeStyle = '#333';
        // Draw axes
        ctx.beginPath();
        ctx.moveTo(marginLeft, h - marginBottom);
        ctx.lineTo(w - marginRight, h - marginBottom);
        ctx.moveTo(marginLeft, h - marginBottom);
        ctx.lineTo(marginLeft, marginTop);
        ctx.stroke();
        // Axis labels
        ctx.save();
        ctx.textAlign = 'center';
        ctx.fillText(options.xLabel, (w - marginRight + marginLeft)/2, h - 5);
        ctx.rotate(-Math.PI/2);
        ctx.fillText(options.yLabel, - (marginTop + (h - marginBottom))/2, 12);
        ctx.restore();
        // Ticks and labels for x and y (assume integer values 1-3)
        const xMin = options.xMin;
        const xMax = options.xMax;
        const yMin = options.yMin;
        const yMax = options.yMax;
        for (let i = xMin; i <= xMax; i++) {
          const xPos = marginLeft + (i - xMin) * (w - marginLeft - marginRight) / (xMax - xMin);
          ctx.beginPath();
          ctx.moveTo(xPos, h - marginBottom);
          ctx.lineTo(xPos, h - marginBottom + 4);
          ctx.stroke();
          ctx.textAlign = 'center';
          ctx.fillText(i.toString(), xPos, h - marginBottom + 14);
        }
        for (let j = yMin; j <= yMax; j++) {
          const yPos = h - marginBottom - (j - yMin) * (h - marginTop - marginBottom) / (yMax - yMin);
          ctx.beginPath();
          ctx.moveTo(marginLeft - 4, yPos);
          ctx.lineTo(marginLeft, yPos);
          ctx.stroke();
          ctx.textAlign = 'right';
          ctx.fillText(j.toString(), marginLeft - 6, yPos + 3);
        }
        // Plot points
        data.forEach(pt => {
          const xPos = marginLeft + (pt.x - xMin) * (w - marginLeft - marginRight) / (xMax - xMin);
          const yPos = h - marginBottom - (pt.y - yMin) * (h - marginTop - marginBottom) / (yMax - yMin);
          // draw circle
          ctx.beginPath();
          ctx.arc(xPos, yPos, 3, 0, Math.PI * 2);
          ctx.fillStyle = '#1a73e8';
          ctx.fill();
          // label near point
          ctx.fillStyle = '#333';
          ctx.textAlign = 'left';
          ctx.fillText(pt.label, xPos + 5, yPos - 2);
        });
      }
      /**
       * Draw a bar chart for overall risk distribution. riskCounts is an object with keys
       * Low, Medium, High, Critical. Bars are coloured accordingly.
       */
      function drawBar(canvas, riskCounts) {
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0,0,w,h);
        // Chart area
        const marginLeft = 40;
        const marginBottom = 40;
        const marginTop = 20;
        const marginRight = 20;
        ctx.font = '10px sans-serif';
        // Determine max
        const categories = ['Low','Medium','High','Critical'];
        const colours = {
          Low: '#d7e7d3',
          Medium: '#fff5d6',
          High: '#f8d7da',
          Critical: '#e5b7b9'
        };
        const maxVal = Math.max(...categories.map(c => riskCounts[c] || 0));
        // If there is no data at all (maxVal = 0), display a simple message and
        // avoid drawing meaningless bars.  This prevents a tiny one‚Äëpixel bar
        // from being rendered when there are zero counts across all risk
        // categories.  The axes are still drawn for context.
        ctx.beginPath();
        ctx.moveTo(marginLeft, h - marginBottom);
        ctx.lineTo(w - marginRight, h - marginBottom);
        ctx.moveTo(marginLeft, h - marginBottom);
        ctx.lineTo(marginLeft, marginTop);
        ctx.strokeStyle = '#333';
        ctx.stroke();
        if (maxVal === 0) {
          // Draw a single y-axis tick at 0
          ctx.textAlign = 'right';
          ctx.fillStyle = '#333';
          ctx.fillText('0', marginLeft - 6, h - marginBottom + 3);
          // Show 'No data' message in the middle of the chart area
          ctx.textAlign = 'center';
          ctx.fillText('No data', (w + marginLeft - marginRight) / 2, (h + marginTop - marginBottom) / 2);
          return;
        }
        // Y ticks: show integer ticks up to max
        const yTickCount = Math.min(maxVal, 5);
        const yStep = Math.ceil(maxVal / yTickCount);
        for (let i = 0; i <= yTickCount; i++) {
          const val = i * yStep;
          const yPos = h - marginBottom - (val / (yTickCount * yStep)) * (h - marginTop - marginBottom);
          ctx.beginPath();
          ctx.moveTo(marginLeft - 3, yPos);
          ctx.lineTo(marginLeft, yPos);
          ctx.stroke();
          ctx.textAlign = 'right';
          ctx.fillStyle = '#333';
          ctx.fillText(val.toString(), marginLeft - 6, yPos + 3);
        }
        // Bars
        const barWidth = (w - marginLeft - marginRight) / categories.length * 0.6;
        categories.forEach((cat, idx) => {
          const val = riskCounts[cat] || 0;
          const barHeight = (val / (yTickCount * yStep)) * (h - marginTop - marginBottom);
          const xPos = marginLeft + (idx + 0.2) * ((w - marginLeft - marginRight) / categories.length);
          const yPos = h - marginBottom - barHeight;
          ctx.fillStyle = colours[cat];
          ctx.fillRect(xPos, yPos, barWidth, barHeight);
          ctx.fillStyle = '#333';
          ctx.textAlign = 'center';
          ctx.fillText(cat, xPos + barWidth/2, h - marginBottom + 12);
          ctx.fillText(val.toString(), xPos + barWidth/2, yPos - 4);
        });
      }
      /*
       * Summary toggle button listener is now attached once within
       * initializeApplication().  The duplicate handler previously
       * defined here caused multiple click events to fire, leading to
       * inconsistent toggle behaviour.  Removing this local binding
       * avoids duplication.  The remaining binding is defined in
       * initializeApplication() near the end of this script.
       */
      // Download CSV
      function downloadCSV() {
        const mill = document.getElementById('inputMill').value || '';
        // Removed username field; adjust CSV header accordingly
        // Export detailed capability dimensions so that consolidation can
        // correctly average each sub capability.  Including individual
        // capability scores (technical knowledge, experience, crisis
        // management, leadership/communication, safety) ensures that
        // downstream merging reflects the full detail of each assessment.
        const header = [
          'Department','Cluster','Role Area','Criticality',
          'Technical Knowledge','Experience','Crisis Management','Leadership/Communication','Safety',
          'Capability (avg)','Retention Risk','Overall Risk',
          'Capability Comment','Retention Comment','Comments',
          'Preferred Method','Gap Method Comment','Mill'
        ];
        // Helper to escape a value for CSV.  If a field contains a comma,
        // newline or double quote, wrap it in quotes and escape existing
        // quotes by doubling them.  Null or undefined values become an
        // empty string.  This ensures that role areas containing commas
        // (e.g. "Production / Area Manager ‚Äì Paper Machine, Finishing & Converting")
        // are safely exported without shifting columns.  The pipe (|)
        // separators remain as-is; they will be converted back to newlines
        // when processing uploaded CSVs.
        function escapeCsv(val) {
          if (val === null || val === undefined) return '';
          let str = String(val);
          // Replace any CR/LF with pipe separators for multiline fields.
          // These replacements are handled for comment fields separately
          // before this helper is invoked.
          if (str.includes('\n') || str.includes('\r')) {
            str = str.replace(/\r?\n/g, ' | ');
          }
          // If the value contains a comma, double quote, or pipe at the start/end,
          // wrap the value in double quotes and escape internal quotes.
          if (str.includes(',') || str.includes('"') ) {
            str = '"' + str.replace(/"/g, '""') + '"';
          }
          return str;
        }
        const lines = [];
        lines.push(header.join(','));
        rows.forEach(r => {
          const crit = r.criticality != null ? r.criticality : '';
          const capTech = r.capTech != null ? r.capTech : '';
          const capExp  = r.capExperience != null ? r.capExperience : '';
          const capCri  = r.capCrisis != null ? r.capCrisis : '';
          const capLead = r.capLeadComm != null ? r.capLeadComm : '';
          const capSafe = r.capSafety != null ? r.capSafety : '';
          const capAvg = r.capabilityAvg != null ? r.capabilityAvg.toFixed(1) : '';
          const ret = r.retentionRisk || '';
          const overall = r.overallRisk || '';
          // Pre-sanitise comment fields: replace newline with pipe separators.
          const capCom = (r.capabilityComment || '').replace(/\r?\n/g, ' | ');
          const retCom = (r.retentionComment || '').replace(/\r?\n/g, ' | ');
          const commentsCombined = displayComments(r).replace(/\n/g, ' | ');
          const pref = r.preferredMethod || '';
          const gap = (r.gapMethodComment || '').replace(/\r?\n/g, ' | ');
          const values = [
            escapeCsv(r.department || ''),
            escapeCsv(r.cluster || ''),
            escapeCsv(r.roleArea || ''),
            escapeCsv(crit),
            escapeCsv(capTech),
            escapeCsv(capExp),
            escapeCsv(capCri),
            escapeCsv(capLead),
            escapeCsv(capSafe),
            escapeCsv(capAvg),
            escapeCsv(ret),
            escapeCsv(overall),
            escapeCsv(capCom),
            escapeCsv(retCom),
            escapeCsv(commentsCombined || ''),
            escapeCsv(pref),
            escapeCsv(gap || ''),
            escapeCsv(mill)
          ];
          lines.push(values.join(','));
        });
        const csvContent = '\uFEFF' + lines.join('\n');
        const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
        const date = new Date();
        const pad = n => n.toString().padStart(2,'0');
        // Update output filename to reflect paper mill
        // Use a more generic filename for the unified plant assessment
        const filename = `plant-skills_${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}_${pad(date.getHours())}${pad(date.getMinutes())}.csv`;
        if (navigator.msSaveBlob) { // IE 10+
          navigator.msSaveBlob(blob, filename);
        } else {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          // Remove the link after a short delay to ensure the download has started.
          setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
          }, 500);
        }
      }

      // Save the current state of the application as a downloadable HTML file.
      // This function encodes the current data for both Mosinee and Thilmany
      // into base64 strings, injects them into copies of the default data
      // scripts, updates the storage key prefixes to a unique timestamped
      // version to avoid conflicts with other pages, and triggers a file
      // download. The resulting file contains all edits made up to the
      // moment of saving and will restore them when opened.
      // Expose saveCurrentVersion on the window so the global onclick handler can call it.
      window.saveCurrentVersion = function() {
        try {
          // Commit any active edits so the latest values are captured
          if (typeof commitEditing === 'function') {
            commitEditing();
          }
          // Gather data for every site: prefer localStorage, fall back to defaults, overlay in-memory edits for the current site
          const allDefaults = {};
          siteNames.forEach(name => {
            let siteRows = [];
            try {
              const saved = localStorage.getItem(storageBasePrefix + name);
              if (saved) {
                const parsed = JSON.parse(saved);
                if (Array.isArray(parsed)) {
                  siteRows = parsed.map(r => Object.assign({}, r));
                }
              }
            } catch (e) {
              /* ignore parse errors */
            }
            if (siteRows.length === 0) {
              const defs = defaultData[name];
              if (defs && Array.isArray(defs)) {
                siteRows = defs.map(r => Object.assign({}, r));
              }
            }
            if (name === currentSite) {
              siteRows = rows.map(r => Object.assign({}, r));
            }
            allDefaults[name] = siteRows;
          });
          // Base64 encode the data using a unicode-safe scheme
          const jsonStr = JSON.stringify(allDefaults);
          const allB64 = btoa(unescape(encodeURIComponent(jsonStr)));
          // Persist visible input values into their attributes so they appear in the saved file
          ['startUserName', 'startPlantName', 'inputMill'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
              el.setAttribute('value', el.value);
            }
          });
          // Ensure the summary page is hidden in the exported file (always start with the table view)
          try {
            summaryVisible = false;
            const summaryEl = document.getElementById('summaryView');
            const dataEl = document.getElementById('dataView');
            const btn = document.getElementById('toggleSummary');
            if (summaryEl) summaryEl.classList.add('hidden');
            if (dataEl) dataEl.classList.remove('hidden');
            if (btn) btn.textContent = 'Show Summary';
          } catch (e) {
            /* if summary not present, ignore */
          }
          // Find or create the <script id="site-defaults"> element and fill it with the Base64 payload
          let siteDefaults = document.getElementById('site-defaults');
          if (!siteDefaults) {
            siteDefaults = document.createElement('script');
            siteDefaults.id = 'site-defaults';
            siteDefaults.type = 'application/json';
            document.body.appendChild(siteDefaults);
          }
          siteDefaults.textContent = allB64;
          // Override the global storageBasePrefix in the saved copy to avoid clashes with other open copies
          const newPrefix = storageBasePrefix + Date.now().toString() + '_';
          let prefixOverride = document.getElementById('storage-prefix-override');
          if (!prefixOverride) {
            prefixOverride = document.createElement('script');
            prefixOverride.id = 'storage-prefix-override';
            document.body.appendChild(prefixOverride);
          }
          prefixOverride.textContent = `window.storageBasePrefix = '${newPrefix}';`;
          // Serialize the entire document
          const html = document.documentElement.outerHTML;
          // Build a timestamped filename
          const now = new Date();
          const timestamp = now.toISOString().replace(/[:T.-]/g, '').slice(0, 14);
          const fname = `plant_skills_assessment_${timestamp}.html`;
          // Save as a blob
          const blob = new Blob([html], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fname;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 500);
        } catch (err) {
          alert('Error saving version: ' + err.message);
        }
      }
      // Ensure saveCurrentVersion remains accessible globally when defined inside the IIFE.
      // Without this, the onclick="saveCurrentVersion()" in the HTML cannot find the function.
      // By assigning it to window, we expose it to the global scope.
      // Attach download CSV handler if the button exists on the page.  On mill pages, this button is omitted.
      {
        const dlBtn = document.getElementById('downloadCsv');
        if (dlBtn) {
          dlBtn.addEventListener('click', downloadCSV);
        }
      }

      /*
       * Consolidation view support
       *
       * The following functions enable uploading multiple CSV responses,
       * averaging their numeric scores, concatenating comments, and
       * optionally updating the main assessment data with the results. A
       * separate view (consolidationView) is defined in the HTML to host
       * the upload controls and the consolidated table. The navigation bar
       * remains visible when scrolling to mirror the behaviour of the main
       * worksheet.
       */

      /*
       * Duplicate implementation of showConsolidation() was defined here
       * within the IIFE.  The global version defined near the top of the
       * script handles view switching and commit editing logic.  Remove
       * this duplicate to avoid unpredictable behaviour from competing
       * definitions.  All references now use the global showConsolidation().
       */

      // Start the assessment by capturing the user's name and plant name.
      // The plant name entered on the start page is used to populate the mill
      // field on the worksheet. After setting the name and plant, the
      // unified "Plant" site is loaded. This function is called by the
      // Start button on the welcome page.
      window.startAssessment = function() {
        // Capture entered values
        const userNameInput = document.getElementById('startUserName');
        const plantNameInput = document.getElementById('startPlantName');
        const userName = userNameInput ? userNameInput.value.trim() : '';
        const plantName = plantNameInput ? plantNameInput.value.trim() : '';
        // Require both the user's name and the plant name.  If either field
        // is empty, alert the user and do not proceed.  This prevents the
        // assessment from loading without the mandatory context requested.
        if (!userName || !plantName) {
          alert('Please enter your name and plant name before starting the assessment.');
          return;
        }
        // Load the single site named "Plant"; this will hide the start view and show the table.
        loadSite('Plant');
        // After the site loads, update the mill field.  Updating after the call
        // ensures that any default population performed by loadSite is
        // overwritten by the user-provided name.
        const millInputEl = document.getElementById('inputMill');
        if (millInputEl) {
          millInputEl.value = plantName;
        }
      };

      // Trigger the hidden file input when the Upload button is clicked
      const uploadBtn = document.getElementById('uploadBtn');
      if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
          const inp = document.getElementById('uploadInput');
          if (inp) inp.click();
        });
      }
      // Listen for file selections on the hidden input - selectedFiles is already global
      const uploadInputEl = document.getElementById('uploadInput');
      if (uploadInputEl) {
        uploadInputEl.addEventListener('change', function(e) {
          const files = Array.from(e.target.files || []);
          if (!selectedFiles) selectedFiles = [];
          // Append all selected files to the list without deduplication.  Different
          // respondents may produce files with identical names or timestamps;
          // treating them as separate inputs ensures that all responses are
          // included.  After processing, the file input value is reset so that
          // the same file can be selected again if needed.
          files.forEach(file => {
            selectedFiles.push(file);
          });
          // Clear previous consolidated output when new files are selected
          const out = document.getElementById('consolidatedOutput');
          if (out) out.innerHTML = '';
          // Reset the file input value so that selecting the same file again
          // will trigger a change event.
          e.target.value = '';
        });
      }

      // Helper: split a CSV line on commas, respecting quoted fields
      function splitCsvLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          const nextCh = i + 1 < line.length ? line[i + 1] : '';
          
          if (ch === '"') {
            if (inQuotes && nextCh === '"') {
              // Escaped quote within quoted field
              current += '"';
              i++; // Skip next quote
            } else {
              // Toggle quote mode
              inQuotes = !inQuotes;
            }
          } else if (ch === ',' && !inQuotes) {
            result.push(current);
            current = '';
          } else {
            current += ch;
          }
        }
        result.push(current);
        return result;
      }

      // Parse CSV content into an array of objects keyed by header names
      function parseCsv(content) {
        // Don't split by newlines first - parse the whole content as CSV
        const rows = [];
        let currentRow = '';
        let inQuotes = false;
        
        // Parse character by character to handle quoted fields with newlines
        for (let i = 0; i < content.length; i++) {
          const ch = content[i];
          const nextCh = i + 1 < content.length ? content[i + 1] : '';
          
          if (ch === '"') {
            if (inQuotes && nextCh === '"') {
              // Escaped quote
              currentRow += '""';
              i++;
            } else {
              // Toggle quote mode
              inQuotes = !inQuotes;
              currentRow += ch;
            }
          } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
            // End of row (only if not in quotes)
            if (ch === '\r' && nextCh === '\n') {
              i++; // Skip LF in CRLF
            }
            if (currentRow.trim()) {
              rows.push(currentRow);
            }
            currentRow = '';
          } else {
            currentRow += ch;
          }
        }
        
        // Don't forget last row
        if (currentRow.trim()) {
          rows.push(currentRow);
        }
        
        if (rows.length === 0) return [];
        
        // Parse header
        const header = splitCsvLine(rows[0]).map(h => h.trim());
        const rowsList = [];
        
        // Parse data rows
        for (let i = 1; i < rows.length; i++) {
          const vals = splitCsvLine(rows[i]);
          const obj = {};
          for (let j = 0; j < header.length; j++) {
            obj[header[j]] = vals[j] !== undefined ? vals[j] : '';
          }
          rowsList.push(obj);
        }
        
        return rowsList;
      }

      // Compute averages and combine comments across all selected files
      function processFiles() {
        // Override processFiles to aggregate responses by mill and role. Each file is assumed
        // to correspond to a particular mill; if the CSV contains a 'Mill' column, that
        // value will be used to determine the mill.  Otherwise, the file name is used.
        if (!selectedFiles || selectedFiles.length === 0) {
          alert('Please select one or more CSV files to process.');
          return;
        }
        const promises = selectedFiles.map(file => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(evt) {
              try {
                const rowsList = parseCsv(evt.target.result);
                resolve(rowsList);
              } catch (err) {
                reject(err);
              }
            };
            reader.onerror = function() {
              reject(reader.error);
            };
            reader.readAsText(file);
          });
        });
        Promise.all(promises).then(allData => {
          const siteAgg = {};
          allData.forEach((dataRows, idx) => {
            const fileName = selectedFiles[idx].name.toLowerCase();
            dataRows.forEach(r => {
              let site = (r['Mill'] || r['Mill Name'] || r['Site'] || r['site'] || '').toString().trim();
              const normaliseSite = function(name) {
                const n = (name || '').toLowerCase();
                // When both "pulp" and "paper" keywords appear in a filename (for example,
                // "billingfors_pulp_and_paper.csv"), the consolidated upload is intended for the
                // Billingfors Paper and Shared view.  The previous order checked for "pulp" first,
                // which meant those hybrid names were assigned to Billingfors Pulp instead and the
                // Paper/Shared aggregation never appeared.  Check for the "paper" keyword before
                // "pulp" so that mixed names correctly route to the Paper/Shared grouping while
                // files that mention only pulp continue to land on the pulp site.
                if (n.includes('paper')) return 'Billingfors Paper and Shared';
                if (n.includes('pulp')) return 'Billingfors Pulp';
                if (n.includes('j√∂n') || n.includes('jonk')) return 'J√∂nk√∂ping';
                return name;
              };
              if (!site) {
                site = normaliseSite(fileName);
              } else {
                site = normaliseSite(site);
              }
              if (!siteAgg[site]) siteAgg[site] = {};
              // Determine the role name.  CSV headers from different sources may use
              // variations such as "Role", "Role Area", "role", "roleArea", "RoleArea",
              // etc.  Normalise by checking a few common cases.  Include lower‚Äëcase
              // "role"/"rolearea" variants so that rows with a "role" header aren't
              // ignored.
              const role = r['Role Area'] || r['Role'] || r['roleArea'] || r['RoleArea']
                          || r['role'] || r['rolearea'] || '';
              if (!role) return;
              if (!siteAgg[site][role]) {
                // Initialise a new entry with separate sums and counts for each metric.  Missing values are ignored in sums and counts.
                siteAgg[site][role] = {
                  count: 0,
                  roleArea: role,
                  critSum: 0,
                  critCount: 0,
                  capTechSum: 0,
                  capTechCount: 0,
                  capExperienceSum: 0,
                  capExperienceCount: 0,
                  capCrisisSum: 0,
                  capCrisisCount: 0,
                  capLeadCommSum: 0,
                  capLeadCommCount: 0,
                  capSafetySum: 0,
                  capSafetyCount: 0,
                  retSum: 0,
                  retCount: 0,
                  capComments: [],
                  retComments: []
                };
              }
              const entry = siteAgg[site][role];
              // Track the total number of responses for this role.
              entry.count++;
              // Criticality: treat blank or '-' as missing
              const rawCrit = r['Criticality'] || r['criticality'] || '';
              let critVal = parseFloat(rawCrit);
              if (rawCrit === '' || rawCrit === '-' || isNaN(critVal)) {
                critVal = null;
              }
              if (critVal !== null) {
                entry.critSum += critVal;
                entry.critCount++;
              }
              // Technical Knowledge. Accept a variety of header names including
              // "Technical Knowledge", "Technical knowledge", "Tech", "tech", and camel/flat
              // variants of the internal capTech field (e.g. capTech, captech, CapTech).
              const rawTech = r['Technical Knowledge'] || r['Technical knowledge'] || r['Tech'] || r['tech']
                              || r['capTech'] || r['captech'] || r['CapTech'] || '';
              let techVal = parseFloat(rawTech);
              if (rawTech === '' || rawTech === '-' || isNaN(techVal)) {
                techVal = null;
              }
              if (techVal !== null) {
                entry.capTechSum += techVal;
                entry.capTechCount++;
              }
              // Experience. Accept "Experience", "experience", "Exp", "exp" and variations of capExperience.
              const rawExp = r['Experience'] || r['experience'] || r['Exp'] || r['exp']
                              || r['capExperience'] || r['capexperience'] || r['CapExperience'] || '';
              let expVal = parseFloat(rawExp);
              if (rawExp === '' || rawExp === '-' || isNaN(expVal)) {
                expVal = null;
              }
              if (expVal !== null) {
                entry.capExperienceSum += expVal;
                entry.capExperienceCount++;
              }
              // Crisis Management. Accept "Crisis Management", "Crisis management", "Crisis", "crisis",
              // and variations of capCrisis (capCrisis, capcrisis, CapCrisis).
              const rawCri = r['Crisis Management'] || r['Crisis management'] || r['Crisis'] || r['crisis']
                              || r['capCrisis'] || r['capcrisis'] || r['CapCrisis'] || '';
              let criVal = parseFloat(rawCri);
              if (rawCri === '' || rawCri === '-' || isNaN(criVal)) {
                criVal = null;
              }
              if (criVal !== null) {
                entry.capCrisisSum += criVal;
                entry.capCrisisCount++;
              }
              // Leadership/Communication. Accept different separator and case variations, as well as
              // abbreviations like "LeadComm", and variations of capLeadComm.
              const rawLead = r['Leadership/Communication'] || r['Leadership / Communication']
                              || r['Leadership/communication'] || r['leadership/communication']
                              || r['LeadComm'] || r['leadcomm']
                              || r['capLeadComm'] || r['capleadcomm'] || r['CapLeadComm'] || '';
              let leadVal = parseFloat(rawLead);
              if (rawLead === '' || rawLead === '-' || isNaN(leadVal)) {
                leadVal = null;
              }
              if (leadVal !== null) {
                entry.capLeadCommSum += leadVal;
                entry.capLeadCommCount++;
              }
              // Safety. Accept "Safety", "safety" and variations of capSafety (capSafety, capsafety, CapSafety).
              const rawSafe = r['Safety'] || r['safety'] || r['capSafety'] || r['capsafety'] || r['CapSafety'] || '';
              let safeVal = parseFloat(rawSafe);
              if (rawSafe === '' || rawSafe === '-' || isNaN(safeVal)) {
                safeVal = null;
              }
              if (safeVal !== null) {
                entry.capSafetySum += safeVal;
                entry.capSafetyCount++;
              }
              // Retention Risk. Accept "Retention Risk", "retention risk", "Retention", "retention",
              // and variations like "retentionRisk", "retentionrisk".
              const rawRet = (r['Retention Risk'] || r['retention risk'] || r['Retention'] || r['retention']
                              || r['retentionRisk'] || r['retentionrisk'] || '').toString().trim();
              let retVal = null;
              if (rawRet && rawRet !== '-') {
                const lowerRet = rawRet.toLowerCase();
                if (lowerRet.startsWith('l') || lowerRet === 'low') {
                  retVal = 1;
                } else if (lowerRet.startsWith('m') || lowerRet === 'medium') {
                  retVal = 2;
                } else if (lowerRet.startsWith('h') || lowerRet === 'high') {
                  retVal = 3;
                }
              }
              if (retVal !== null) {
                entry.retSum += retVal;
                entry.retCount++;
              }
              // Capability comments: detect any header variant that refers to capability comments.
              // CSVs generated by different tools or hand‚Äëedited responses may use different
              // casing, spacing, underscores or singular/plural forms (e.g. "Capability Comment",
              // "capability_comments" or "Capability comments").  To robustly capture these,
              // scan all keys on the row for ones that normalise to start with
              // "capabilitycomment" after removing punctuation.
              (function() {
                let combined = '';
                Object.keys(r).forEach(key => {
                  const norm = key
                    .toString()
                    .toLowerCase()
                    // Normalise by stripping spaces, underscores, hyphens, parentheses and other
                    // punctuation so that suffixed headers such as "Capability Comments (Detailed)"
                    // or "capability_comments-2024" are still recognised during consolidation.
                    .replace(/[^a-z0-9]/g, '');
                  if (norm.startsWith('capabilitycomment')) {
                    const val = (r[key] || '').toString();
                    if (val) {
                      if (combined) combined += '\n';
                      combined += val;
                    }
                  }
                });
                if (combined) {
                  // Replace pipe separators with newlines for aggregation and trim whitespace.
                  const cleaned = combined.replace(/\s*\|\s*/g, '\n').trim();
                  if (cleaned) {
                    entry.capComments.push(cleaned);
                  }
                }
              })();
              // Retention comments: handle multiple header variants similarly to capability comments.
              (function() {
                let combined = '';
                Object.keys(r).forEach(key => {
                  const norm = key
                    .toString()
                    .toLowerCase()
                    .replace(/[^a-z0-9]/g, '');
                  if (norm.startsWith('retentioncomment')) {
                    const val = (r[key] || '').toString();
                    if (val) {
                      if (combined) combined += '\n';
                      combined += val;
                    }
                  }
                });
                if (combined) {
                  const cleaned = combined.replace(/\s*\|\s*/g, '\n').trim();
                  if (cleaned) {
                    entry.retComments.push(cleaned);
                  }
                }
              })();
            });
          });
          consolidatedData = [];
          Object.keys(siteAgg).forEach(site => {
            const rolesObj = siteAgg[site];
            Object.values(rolesObj).forEach(item => {
              // Compute per-dimension averages based on the number of non-null entries for each metric.
              const avgCrit = item.critCount > 0 ? item.critSum / item.critCount : null;
              const avgTech  = item.capTechCount > 0 ? item.capTechSum / item.capTechCount : null;
              const avgExp   = item.capExperienceCount > 0 ? item.capExperienceSum / item.capExperienceCount : null;
              const avgCri   = item.capCrisisCount > 0 ? item.capCrisisSum / item.capCrisisCount : null;
              const avgLead  = item.capLeadCommCount > 0 ? item.capLeadCommSum / item.capLeadCommCount : null;
              const avgSafe  = item.capSafetyCount > 0 ? item.capSafetySum / item.capSafetyCount : null;
              // Compute the overall capability average by averaging only the available sub-dimensions.
              let avgCap = null;
              const subVals = [avgTech, avgExp, avgCri, avgLead, avgSafe].filter(v => v != null);
              if (subVals.length > 0) {
                avgCap = subVals.reduce((a,b) => a + b, 0) / subVals.length;
              }
              // Compute the retention risk average; if no values provided, leave blank.
              const avgRet = item.retCount > 0 ? (item.retSum / item.retCount) : null;
              let retLetter = '';
              if (avgRet !== null) {
                const roundRet = Math.round(avgRet);
                if (roundRet === 1) retLetter = 'L';
                else if (roundRet === 2) retLetter = 'M';
                else if (roundRet === 3) retLetter = 'H';
              }
              const uniq = arr => {
                const seen = new Set();
                const unique = [];
                arr.filter(s => s).forEach(comment => {
                  const normalized = comment.trim().replace(/\s+/g, ' ');
                  if (!seen.has(normalized)) {
                    seen.add(normalized);
                    unique.push(comment);
                  }
                });
                return unique;
              };
              const capCom = uniq(item.capComments).join('\n');
              const retCom = uniq(item.retComments).join('\n');
              consolidatedData.push({
                mill: site,
                roleArea: item.roleArea,
                criticality: avgCrit != null ? parseFloat(avgCrit.toFixed(1)) : null,
                capTech: avgTech != null ? parseFloat(avgTech.toFixed(1)) : null,
                capExperience: avgExp != null ? parseFloat(avgExp.toFixed(1)) : null,
                capCrisis: avgCri != null ? parseFloat(avgCri.toFixed(1)) : null,
                capLeadComm: avgLead != null ? parseFloat(avgLead.toFixed(1)) : null,
                capSafety: avgSafe != null ? parseFloat(avgSafe.toFixed(1)) : null,
                capabilityAvg: avgCap != null ? parseFloat(avgCap.toFixed(1)) : null,
                retentionRisk: retLetter,
                capabilityComment: capCom,
                retentionComment: retCom
              });
            });
          });
          renderConsolidatedTable();
        }).catch(err => {
          console.error('Error processing files', err);
          alert('Error processing files: ' + err.message);
        });
      }

      // Clear any selected files and consolidated output.  This allows the user to
      // reset the consolidation view without reloading the page.  It also
      // empties the file input so the same file can be selected again if needed.
      function clearConsolidated() {
        selectedFiles = [];
        consolidatedData = [];
        const inputEl = document.getElementById('uploadInput');
        if (inputEl) {
          inputEl.value = '';
        }
        const out = document.getElementById('consolidatedOutput');
        if (out) out.innerHTML = '';
      }

      // Render the consolidated data into an HTML table within the consolidation view
      function renderConsolidatedTable() {
        const outEl = document.getElementById('consolidatedOutput');
        if (!outEl) return;
        if (!consolidatedData || !consolidatedData.length) {
          outEl.innerHTML = '<p>No data to display.</p>';
          return;
        }
        // Group consolidated rows by mill.  Each mill will have its own section
        const grouped = {};
        consolidatedData.forEach(item => {
          const mill = item.mill || 'Unknown';
          if (!grouped[mill]) grouped[mill] = [];
          grouped[mill].push(item);
        });
        let html = '';
        Object.keys(grouped).forEach(millName => {
          const rows = grouped[millName];
          // Section heading for each mill
          html += '<h3 style="margin-top:12px;">' + millName + '</h3>';
          html += '<table style="width:100%; border-collapse:collapse; font-size:0.8rem; margin-bottom:16px;">';
          // Add a Mill column so that each row clearly identifies the originating mill
          // Include per-dimension preview columns (Tech, Exp, Crisis, Lead/Comm, Safety) for verification
          html += '<thead><tr>' +
            '<th style="border:1px solid #ccc; padding:4px;">Mill</th>' +
            '<th style="border:1px solid #ccc; padding:4px;">Role Area</th>' +
            '<th style="border:1px solid #ccc; padding:4px; text-align:center;">Criticality</th>' +
            '<th style="border:1px solid #ccc; padding:4px; text-align:center;">Tech</th>' +
            '<th style="border:1px solid #ccc; padding:4px; text-align:center;">Exp</th>' +
            '<th style="border:1px solid #ccc; padding:4px; text-align:center;">Crisis</th>' +
            '<th style="border:1px solid #ccc; padding:4px; text-align:center;">Lead/Comm</th>' +
            '<th style="border:1px solid #ccc; padding:4px; text-align:center;">Safety</th>' +
            '<th style="border:1px solid #ccc; padding:4px; text-align:center;">Capability Avg</th>' +
            '<th style="border:1px solid #ccc; padding:4px; text-align:center;">Retention Risk</th>' +
            '<th style="border:1px solid #ccc; padding:4px;">Capability Comments</th>' +
            '<th style="border:1px solid #ccc; padding:4px;">Retention Comments</th>' +
            '</tr></thead>';
          html += '<tbody>';
          rows.forEach(r => {
            const critClass = (r.criticality != null ? ('crit-' + Math.round(r.criticality)) : '');
            const capBucket = (r.capabilityAvg != null ? bucketCapability(r.capabilityAvg) : null);
            const capClass = (capBucket != null ? ('cap-' + capBucket) : '');
            const retVal = (r.retentionRisk || '').toString().trim();
            const retClass = retVal ? ('ret-' + retVal) : '';
            // Prepare per-dimension strings and classes
            const techStr = (r.capTech != null && !isNaN(r.capTech)) ? r.capTech.toFixed(1) : '';
            const techClass = (r.capTech != null && !isNaN(r.capTech)) ? ('cap-' + bucketCapability(r.capTech)) : '';
            const expStr  = (r.capExperience != null && !isNaN(r.capExperience)) ? r.capExperience.toFixed(1) : '';
            const expClass = (r.capExperience != null && !isNaN(r.capExperience)) ? ('cap-' + bucketCapability(r.capExperience)) : '';
            const criStr  = (r.capCrisis != null && !isNaN(r.capCrisis)) ? r.capCrisis.toFixed(1) : '';
            const criClass = (r.capCrisis != null && !isNaN(r.capCrisis)) ? ('cap-' + bucketCapability(r.capCrisis)) : '';
            const leadStr = (r.capLeadComm != null && !isNaN(r.capLeadComm)) ? r.capLeadComm.toFixed(1) : '';
            const leadClass = (r.capLeadComm != null && !isNaN(r.capLeadComm)) ? ('cap-' + bucketCapability(r.capLeadComm)) : '';
            const safeStr = (r.capSafety != null && !isNaN(r.capSafety)) ? r.capSafety.toFixed(1) : '';
            const safeClass = (r.capSafety != null && !isNaN(r.capSafety)) ? ('cap-' + bucketCapability(r.capSafety)) : '';
            html += '<tr>' +
              '<td style="border:1px solid #ccc; padding:4px;">' + (millName || '') + '</td>' +
              '<td style="border:1px solid #ccc; padding:4px;">' + (r.roleArea || '') + '</td>' +
              '<td class="' + critClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + (r.criticality != null ? r.criticality.toFixed(1) : '') + '</td>' +
              '<td class="' + techClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + techStr + '</td>' +
              '<td class="' + expClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + expStr + '</td>' +
              '<td class="' + criClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + criStr + '</td>' +
              '<td class="' + leadClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + leadStr + '</td>' +
              '<td class="' + safeClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + safeStr + '</td>' +
              '<td class="' + capClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + (r.capabilityAvg != null ? r.capabilityAvg.toFixed(1) : '') + '</td>' +
              '<td class="' + retClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + (retVal || '') + '</td>' +
              '<td style="border:1px solid #ccc; padding:4px; white-space:pre-wrap;">' + (r.capabilityComment || '') + '</td>' +
              '<td style="border:1px solid #ccc; padding:4px; white-space:pre-wrap;">' + (r.retentionComment || '') + '</td>' +
              '</tr>';
          });
          html += '</tbody></table>';
        });
        outEl.innerHTML = html;
      }

      // Export the consolidated data to a CSV file
      function downloadConsolidated() {
        if (!consolidatedData || !consolidatedData.length) {
          alert('No consolidated data to download.');
          return;
        }
        // Include the five sub-dimensions in the consolidated CSV header so that downstream tools have raw values.
        const header = [
          'Role Area',
          'Criticality',
          'Technical Knowledge',
          'Experience',
          'Crisis Management',
          'Leadership/Communication',
          'Safety',
          'Capability (avg)',
          'Retention Risk',
          'Capability Comment',
          'Retention Comment'
        ];
        const lines = [];
        lines.push(header.join(','));
        consolidatedData.forEach(r => {
          // Round each sub-dimension and the overall average to one decimal place; leave blank if null.
          const critStr = (r.criticality != null && !isNaN(r.criticality)) ? r.criticality.toFixed(1) : '';
          const techStr = (r.capTech != null && !isNaN(r.capTech)) ? r.capTech.toFixed(1) : '';
          const expStr  = (r.capExperience != null && !isNaN(r.capExperience)) ? r.capExperience.toFixed(1) : '';
          const criStr  = (r.capCrisis != null && !isNaN(r.capCrisis)) ? r.capCrisis.toFixed(1) : '';
          const leadStr = (r.capLeadComm != null && !isNaN(r.capLeadComm)) ? r.capLeadComm.toFixed(1) : '';
          const safeStr = (r.capSafety != null && !isNaN(r.capSafety)) ? r.capSafety.toFixed(1) : '';
          const capAvgStr = (r.capabilityAvg != null && !isNaN(r.capabilityAvg)) ? r.capabilityAvg.toFixed(1) : '';
          // Flatten comments: replace newlines with pipes to ensure single-line CSV rows
          const capCom = (r.capabilityComment || '').replace(/\n/g, '|');
          const retCom = (r.retentionComment || '').replace(/\n/g, '|');
          const values = [
            r.roleArea || '',
            critStr,
            techStr,
            expStr,
            criStr,
            leadStr,
            safeStr,
            capAvgStr,
            r.retentionRisk || '',
            '"' + capCom.replace(/"/g, '""') + '"',
            '"' + retCom.replace(/"/g, '""') + '"'
          ];
          lines.push(values.join(','));
        });
        const csvContent = '\uFEFF' + lines.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        const filename = 'consolidated_responses_' + now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate()) + '.csv';
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        // Delay removal to ensure download initiation in all browsers.
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);
        }, 500);
      }

      // Override updateToolData so that only the appropriate mill pages are updated.  This function
      // loops through the consolidated data grouped by mill, loads the current saved
      // data for each mill, updates matching roles with the consolidated averages
      // and comments, and writes the results back to localStorage.  If the
      // currently viewed mill is updated, it re-renders the table.
      function updateToolData() {
        // Always commit any active cell edits first so the in-memory data reflects
        // the latest user changes. Without this, edits made just before
        // consolidation may be lost. Only call commitEditing if it exists.
        if (typeof commitEditing === 'function') {
          commitEditing();
        }
        if (!consolidatedData || !consolidatedData.length) {
          alert('No consolidated data to update.');
          return;
        }
        const bySite = {};
        consolidatedData.forEach(row => {
          const site = row.mill || '';
          if (!bySite[site]) bySite[site] = [];
          bySite[site].push(row);
        });
        Object.keys(bySite).forEach(site => {
          const rowsForSite = bySite[site];
          let existingRows = [];
          const key = storageBasePrefix + site;
          try {
            const saved = localStorage.getItem(key);
            if (saved) {
              const parsed = JSON.parse(saved);
              if (Array.isArray(parsed)) {
                existingRows = parsed.map(r => Object.assign({}, r));
              }
            }
          } catch (e) { /* ignore */ }
          if (existingRows.length === 0) {
            const defs = defaultData[site];
            if (defs && Array.isArray(defs)) {
              existingRows = defs.map(r => Object.assign({}, r));
            }
          }
          function normalizeRole(role) {
            return (role || '').toLowerCase().replace(/\(.*?\)/g, '').replace(/[-‚Äì]/g, ' ').replace(/\s+/g, ' ').trim();
          }
          rowsForSite.forEach(item => {
            const targetIndex = existingRows.findIndex(r => normalizeRole(r.roleArea) === normalizeRole(item.roleArea));
            if (targetIndex >= 0) {
              const r = existingRows[targetIndex];
              if (item.criticality != null) r.criticality = item.criticality;
              // Round all capability sub-dimensions to nearest integer
              if (item.capTech != null) r.capTech = Math.round(item.capTech);
              if (item.capExperience != null) r.capExperience = Math.round(item.capExperience);
              if (item.capCrisis != null) r.capCrisis = Math.round(item.capCrisis);
              if (item.capLeadComm != null) r.capLeadComm = Math.round(item.capLeadComm);
              if (item.capSafety != null) r.capSafety = Math.round(item.capSafety);
              // Persist capability and retention comments exactly as aggregated.  Replace pipe
              // separators with newlines if any remain (older aggregated rows may still use pipes).
              r.capabilityComment = item.capabilityComment ? item.capabilityComment.replace(/\|/g, '\n') : '';
              r.retentionRisk = item.retentionRisk || '';
              r.retentionComment = item.retentionComment ? item.retentionComment.replace(/\|/g, '\n') : '';
              r.comments = '';
              r.preferredMethod = '-';
              r.gapMethodComment = '';
              r.capabilityAvg = computeCapabilityAvg(r);
              r.capabilityBucket = bucketCapability(r.capabilityAvg);
              r.overallRisk = computeOverallRisk(r);
            }
          });
          try {
            localStorage.setItem(key, JSON.stringify(existingRows));
          } catch (e) { /* ignore quota errors */ }
          if (site === currentSite) {
            rows = existingRows.map((r, idx) => {
              const obj = Object.assign({}, r);
              obj.id = idx;
              return obj;
            });
            renderTable();
            setTimeout(() => { reapplyAllColors(); }, 50);
          }
        });
        const consDiv = document.getElementById('consolidationView');
        if (consDiv) consDiv.style.display = 'none';
        showStart();
        alert('Tool updated with consolidated data.');
      }

      // Expose the global startSite implementation on window rather than
      // redefining it here.  A duplicate implementation previously lived
      // inside the IIFE, causing two different code paths depending on
      // which version was called.  Reassigning window.startSite to the
      // global startSite function ensures that the single authoritative
      // implementation (defined near the top of this script) is used
      // everywhere.  The global function handles user name validation,
      // commits edits, loads the selected site and updates UI state.
      window.startSite = startSite;

      // Download data across all sites into a single CSV file.  This is called
      // from the welcome page.  It compiles each site's rows, including any
      // unsaved edits for the current site, and writes them with a Mill
      // column so that downstream users can identify which mill each record
      // belongs to.  Comment fields are flattened with pipe separators.
      window.downloadAllCSV = function() {
        // Commit any in-progress edits so the current site data is up to date
        if (typeof commitEditing === 'function') {
          commitEditing();
        }
        const header = [
          'Mill',
          'Role Area',
          'Criticality',
          'Technical Knowledge',
          'Experience',
          'Crisis Management',
          'Leadership/Communication',
          'Safety',
          'Capability (avg)',
          'Retention Risk',
          'Capability Comment',
          'Retention Comment'
        ];
        const lines = [header.join(',')];
        siteNames.forEach(site => {
          let siteRows = [];
          try {
            const saved = localStorage.getItem(storageBasePrefix + site);
            if (saved) {
              const parsed = JSON.parse(saved);
              if (Array.isArray(parsed)) {
                siteRows = parsed.map(r => Object.assign({}, r));
              }
            }
          } catch (e) { /* ignore */ }
          if (siteRows.length === 0) {
            const defs = defaultData[site];
            if (defs && Array.isArray(defs)) {
              siteRows = defs.map(r => Object.assign({}, r));
            }
          }
          if (site === currentSite) {
            siteRows = rows.map(r => Object.assign({}, r));
          }
          siteRows.forEach(row => {
            // Compute the overall capability average fresh from the five sub-dimensions
            const capAvg = computeCapabilityAvg(row);
            const capAvgStr = capAvg != null ? capAvg.toFixed(1) : '';
            // Prepare each of the five sub-dimension values, rounded to one decimal where available.
            const techVal = row.capTech;
            const techStr = (techVal !== null && techVal !== undefined && techVal !== '' && !isNaN(parseFloat(techVal)))
              ? parseFloat(techVal).toFixed(1)
              : '';
            const expVal = row.capExperience;
            const expStr = (expVal !== null && expVal !== undefined && expVal !== '' && !isNaN(parseFloat(expVal)))
              ? parseFloat(expVal).toFixed(1)
              : '';
            const criVal = row.capCrisis;
            const criStr = (criVal !== null && criVal !== undefined && criVal !== '' && !isNaN(parseFloat(criVal)))
              ? parseFloat(criVal).toFixed(1)
              : '';
            const leadVal = row.capLeadComm;
            const leadStr = (leadVal !== null && leadVal !== undefined && leadVal !== '' && !isNaN(parseFloat(leadVal)))
              ? parseFloat(leadVal).toFixed(1)
              : '';
            const safeVal = row.capSafety;
            const safeStr = (safeVal !== null && safeVal !== undefined && safeVal !== '' && !isNaN(parseFloat(safeVal)))
              ? parseFloat(safeVal).toFixed(1)
              : '';
            // Replace newlines in comments with pipes to avoid breaking CSV format
            const capComment = (row.capabilityComment || '').replace(/\n/g, '|');
            const retComment = (row.retentionComment || '').replace(/\n/g, '|');
            const line = [
              site.replace(/,/g, ' '),
              (row.roleArea || '').replace(/,/g, ' '),
              row.criticality != null && row.criticality !== '' ? row.criticality : '',
              techStr,
              expStr,
              criStr,
              leadStr,
              safeStr,
              capAvgStr,
              row.retentionRisk || '',
              '"' + capComment.replace(/"/g, '""') + '"',
              '"' + retComment.replace(/"/g, '""') + '"'
            ].join(',');
            lines.push(line);
          });
        });
        const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const dt = new Date();
        const ts = dt.toISOString().replace(/[:T.-]/g, '').slice(0, 14);
        a.href = url;
        a.download = `mill_assessments_${ts}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // Set up handlers for the consolidation view.  When the document is loaded
      // normally the DOMContentLoaded event will fire and call this.  When
      // loading a saved copy of the tool the event may have already fired, so
      // call it immediately if the page is already past the loading stage.
      function setupConsolidationButtons() {
        const processBtn = document.getElementById('processBtn');
        if (processBtn) processBtn.addEventListener('click', processFiles);
        const downloadBtn = document.getElementById('downloadConsolidatedBtn');
        if (downloadBtn) downloadBtn.addEventListener('click', downloadConsolidated);
        const updateBtn = document.getElementById('updateToolBtn');
        if (updateBtn) updateBtn.addEventListener('click', updateToolData);
        const clearBtn = document.getElementById('clearConsolidatedBtn');
        if (clearBtn) clearBtn.addEventListener('click', clearConsolidated);
      }
      
      // Comprehensive initialization function
      function initializeApplication() {
        // Prevent running initialization more than once. Multiple invocations
        // would attach duplicate event listeners leading to issues like the
        // summary button not responding correctly.
        if (appInitialized) {
          return;
        }
        appInitialized = true;

        // Setup consolidation buttons
        setupConsolidationButtons();
        
        // Setup print button
        const printBtn = document.getElementById('printBtn');
        if (printBtn) {
          printBtn.addEventListener('click', () => {
            window.print();
          });
        }
        
        // Setup save button
        const saveBtn = document.getElementById('saveVersion');
        if (saveBtn) {
          saveBtn.addEventListener('click', saveCurrentVersion);
        }
        
        // Setup download CSV button
        const dlBtn = document.getElementById('downloadCsv');
        if (dlBtn) {
          // Bind the download button to the per-site CSV export.  The original
          // application defines downloadCSV in the main script; this ensures the
          // correct export is used.
          dlBtn.addEventListener('click', downloadCSV);
        }
        
        // Setup toggle summary button
        const btnToggle = document.getElementById('toggleSummary');
        if (btnToggle) {
          btnToggle.addEventListener('click', () => {
            const summary = document.getElementById('summaryView');
            const dataView = document.getElementById('dataView');
            // Toggle the visibility of the summary and data views. Store the
            // visibility state so it can be restored when switching plants.
            if (summary.classList.contains('hidden')) {
              // Show summary
              generateSummary();
              summary.classList.remove('hidden');
              dataView.classList.add('hidden');
              btnToggle.textContent = 'Show Full Data';
              summaryVisible = true;
            } else {
              // Show full data
              summary.classList.add('hidden');
              dataView.classList.remove('hidden');
              btnToggle.textContent = 'Show Summary';
              summaryVisible = false;
            }
          });
        }
        
        // Setup upload button
        const uploadBtn = document.getElementById('uploadBtn');
        if (uploadBtn) {
          uploadBtn.addEventListener('click', function() {
            const inp = document.getElementById('uploadInput');
            if (inp) inp.click();
          });
        }
        
        // Setup file input listener
        const uploadInputEl = document.getElementById('uploadInput');
        if (uploadInputEl) {
          uploadInputEl.addEventListener('change', function(e) {
            const files = Array.from(e.target.files || []);
            if (!selectedFiles) selectedFiles = [];
            files.forEach(file => {
              selectedFiles.push(file);
            });
            const out = document.getElementById('consolidatedOutput');
            if (out) out.innerHTML = '';
            e.target.value = '';
          });
        }
        
        // Show the start screen
        showStart();
      }
      
      // Create a function that ensures all global functions are properly attached to window
      function ensureGlobalFunctions() {
        // Make absolutely sure all functions are attached to window
        if (typeof loadSite === 'function') window.loadSite = loadSite;
        if (typeof showStart === 'function') window.showStart = showStart;
        if (typeof showConsolidation === 'function') window.showConsolidation = showConsolidation;
        if (typeof startSite === 'function') window.startSite = startSite;
        if (typeof downloadAllCSV === 'function') window.downloadAllCSV = downloadAllCSV;
        if (typeof saveCurrentVersion === 'function') window.saveCurrentVersion = saveCurrentVersion;
        if (typeof resetData === 'function') window.resetData = resetData;
        if (typeof startAssessment === 'function') window.startAssessment = startAssessment;
      }
      
      // Run initialization when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          ensureGlobalFunctions();
          initializeApplication();
        });
      } else {
        // DOM is already loaded (happens in saved HTML files)
        ensureGlobalFunctions();
        // Use setTimeout to ensure all scripts are fully executed
        setTimeout(function() {
          ensureGlobalFunctions();
          initializeApplication();
        }, 100);
      }
      
      // Also ensure functions are available after a short delay as a final fallback
      setTimeout(function() {
        ensureGlobalFunctions();
      }, 500);
    })();
  </script>
  <!-- Added fix to expose critical functions globally when saved locally -->
  <script>
  // Force all critical functions to be available globally
  // This runs AFTER all other scripts have loaded
  window.addEventListener('load', function() {
    // Ensure functions are available globally
    if (typeof showStart !== 'function') {
      window.showStart = function() {
        var siteDiv = document.getElementById('siteContent');
        var startDiv = document.getElementById('startView');
        var consDiv = document.getElementById('consolidationView');
        if (siteDiv) siteDiv.style.display = 'none';
        if (startDiv) startDiv.style.display = '';
        if (consDiv) consDiv.style.display = 'none';
      };
    }
    if (typeof showConsolidation !== 'function') {
      window.showConsolidation = function() {
        var startDiv = document.getElementById('startView');
        var siteDiv = document.getElementById('siteContent');
        var consDiv = document.getElementById('consolidationView');
        if (startDiv) startDiv.style.display = 'none';
        if (siteDiv) siteDiv.style.display = 'none';
        if (consDiv) consDiv.style.display = '';
      };
    }
    if (typeof startSite !== 'function') {
      window.startSite = function(siteName) {
        var nameEl = document.getElementById('startUserName');
        var userName = nameEl ? nameEl.value.trim() : '';
        if (!userName) {
          alert('Please enter your name before starting.');
          return;
        }
        // Trigger the main application's loadSite function
        // This will work if the main app has loaded
        if (window.loadSite) {
          window.loadSite(siteName);
        } else {
          alert('Application not fully loaded. Please refresh the page and try again.');
        }
      };
    }
    if (typeof downloadAllCSV !== 'function') {
      window.downloadAllCSV = function() {
        alert('This feature needs to be reimplemented. Please use the original unsaved version.');
      };
    }
    if (typeof saveCurrentVersion !== 'function') {
      // Do not override saveCurrentVersion in the fallback script.  The
      // original application defines a full saveCurrentVersion handler and
      // the early stub delegates to it.  If we were to override it here we
      // would block the real save logic and show an unnecessary alert.  See
      // comments earlier in this file for details.
    }
    if (typeof resetData !== 'function') {
      window.resetData = function() {
        if (confirm('Reset all data to defaults?')) {
          localStorage.clear();
          location.reload();
        }
      };
    }
    // Ensure the start view is shown on load
    if (window.showStart) {
      window.showStart();
    }
  });
  </script>
</body></html>